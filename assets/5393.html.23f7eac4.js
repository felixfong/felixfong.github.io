import{e as s}from"./app.dbf5d933.js";import{_ as a}from"./plugin-vue_export-helper.21dcd24c.js";const n={},e=s(`<h2 id="_1-\u90E8\u7F72" tabindex="-1"><a class="header-anchor" href="#_1-\u90E8\u7F72" aria-hidden="true">#</a> 1\uFF0C\u90E8\u7F72</h2><p>\u5148\u6765\u90E8\u7F72\u4E00\u4E2A\u5355\u673A\u7248\u7684 etcd\u3002\u56FD\u5916\u96BE\u4EE5\u4E0B\u8F7D\uFF0C\u611F\u8C22\u534E\u4E3A\u955C\u50CF\u7AD9\uFF1Ahttps://mirrors.huaweicloud.com/etcd/</p><p>\u4E0B\u8F7D\u5230\u672C\u673A\u89E3\u538B\u653E\u5230\u5BF9\u5E94\u76EE\u5F55\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">tar</span> xf etcd-v3.3.11-linux-amd64.tar.gz
<span class="token builtin class-name">cd</span> etcd-v3.3.11-linux-amd64/
<span class="token function">mv</span> etcd etcdctl /usr/bin/
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u56E0\u4E3A\u9ED8\u8BA4\u7684\u7A7A\u95F4\u914D\u989D\u662F 2G\uFF0C\u5B98\u65B9\u4E0B\u8F7D\u7684\u5305\u5185\uFF0C\u6709\u5982\u4E0B\u8BF4\u660E\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>The default storage size limit is 2GB, configurable with <span class="token variable"><span class="token variable">\`</span>--quota-backend-bytes<span class="token variable">\`</span></span> flag. 8GB is a suggested maximum size <span class="token keyword">for</span> normal environments and etcd warns at startup <span class="token keyword">if</span> the configured value exceeds it.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>\u8FD9\u91CC\u5C06\u914D\u989D\u6307\u5B9A\u4E3A 16M \u4FBF\u4E8E\u6D4B\u8BD5\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ etcd --quota-backend-bytes<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token variable">))</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>\u542F\u52A8\u4E4B\u540E\uFF0C\u9996\u5148\u67E5\u770B\u4E00\u4E0B\u72B6\u6001\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl --endpoints<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:2379&quot;</span> --write-out<span class="token operator">=</span>table endpoint status
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
<span class="token operator">|</span>       ENDPOINT        <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span>
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
<span class="token operator">|</span> http://127.0.0.1:2379 <span class="token operator">|</span> 8e9e05c52164694d <span class="token operator">|</span>  <span class="token number">3.3</span>.11 <span class="token operator">|</span>   <span class="token number">20</span> KB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>         <span class="token number">15</span> <span class="token operator">|</span>
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_2-\u6D4B\u8BD5" aria-hidden="true">#</a> 2\uFF0C\u6D4B\u8BD5</h2><p>\u63A5\u7740\u6279\u91CF\u5199\u5165\uFF0C\u67E5\u770B\u72B6\u6001\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/urandom <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1024</span>  <span class="token operator">|</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl put key  <span class="token operator">||</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
\u3002\u3002\u3002\u3002\u3002\u3002
<span class="token number">1024</span>+0 records <span class="token keyword">in</span>
<span class="token number">1024</span>+0 records out
<span class="token number">1048576</span> bytes <span class="token punctuation">(</span><span class="token number">1.0</span> MB<span class="token punctuation">)</span> copied, <span class="token number">0.0830886</span> s, <span class="token number">12.6</span> MB/s
Error: etcdserver: mvcc: database space exceeded
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>\u770B\u5230\u4E00\u4E2A\u62A5\u9519\u8BF4\uFF1A<code>Error: etcdserver: mvcc: database space exceeded</code>\uFF0C\u4EA6\u5373\u8D85\u51FA\u4E86\u914D\u989D\uFF0C\u6267\u884C\u7B80\u5355\u7684\u5199\u5165\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl put newkey <span class="token number">123</span>
Error: etcdserver: mvcc: database space exceeded
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u4F9D\u7136\u662F\u8FD9\u4E2A\u9519\u8BEF\uFF0C\u518D\u770B\u670D\u52A1\u72B6\u6001\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl --endpoints<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:2379&quot;</span> --write-out<span class="token operator">=</span>table endpoint status
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
<span class="token operator">|</span>       ENDPOINT        <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span>
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
<span class="token operator">|</span> http://127.0.0.1:2379 <span class="token operator">|</span> 8e9e05c52164694d <span class="token operator">|</span>  <span class="token number">3.3</span>.11 <span class="token operator">|</span>   <span class="token number">17</span> MB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>         <span class="token number">3</span> <span class="token operator">|</span>         <span class="token number">18</span> <span class="token operator">|</span>
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>\u5F88\u660E\u663E\u8D85\u51FA\u4E86\u914D\u989D\u3002</p><p>\u4F7F\u7528\u5982\u4E0B\u547D\u4EE4\u67E5\u770B\u544A\u8B66\u4FE1\u606F\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl put newkey <span class="token number">123</span>
Error: etcdserver: mvcc: database space exceeded
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u6240\u6709\u7684\u8FD0\u7EF4\u7BA1\u7406\u90FD\u5728\u64CD\u4F5C Etcd \u7684\u5B58\u50A8\u7A7A\u95F4\u3002\u5B58\u50A8\u7A7A\u95F4\u7684\u914D\u989D\u7528\u4E8E\u63A7\u5236 Etcd \u6570\u636E\u7A7A\u95F4\u7684\u5927\u5C0F\uFF0C\u5982\u679C Etcd \u8282\u70B9\u78C1\u76D8\u7A7A\u95F4\u4E0D\u8DB3\u4E86\uFF0C\u914D\u989D\u4F1A\u89E6\u53D1\u544A\u8B66\uFF0C\u7136\u540E Etcd \u7CFB\u7EDF\u5C06\u8FDB\u5165\u64CD\u4F5C\u53D7\u9650\u7684\u7EF4\u62A4\u6A21\u5F0F\u3002</p><h2 id="_3-\u538B\u7F29" tabindex="-1"><a class="header-anchor" href="#_3-\u538B\u7F29" aria-hidden="true">#</a> 3\uFF0C\u538B\u7F29</h2><p>\u5904\u7406\u7684\u65B9\u6848\u662F\u53EF\u4EE5\u9488\u5BF9\u5982\u4E0A\u5185\u5BB9\u8FDB\u884C\u538B\u7F29\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#\u4F7F\u7528API3</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> 
<span class="token comment"># \u83B7\u53D6\u5F53\u524D\u7248\u672C</span>
$ <span class="token assign-left variable">rev</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>etcdctl --endpoints<span class="token operator">=</span>http://127.0.0.1:2379 endpoint status --write-out<span class="token operator">=</span><span class="token string">&quot;json&quot;</span> <span class="token operator">|</span> <span class="token function">egrep</span> -o <span class="token string">&#39;&quot;revision&quot;:[0-9]*&#39;</span> <span class="token operator">|</span> <span class="token function">egrep</span> -o <span class="token string">&#39;[0-9].*&#39;</span><span class="token variable">)</span></span>
<span class="token comment"># \u538B\u7F29\u6389\u6240\u6709\u65E7\u7248\u672C</span>
etcdctl --endpoints<span class="token operator">=</span>http://127.0.0.1:2379 compact <span class="token variable">$rev</span>
<span class="token comment"># \u6574\u7406\u591A\u4F59\u7684\u7A7A\u95F4</span>
etcdctl --endpoints<span class="token operator">=</span>http://127.0.0.1:2379 defrag
<span class="token comment"># \u53D6\u6D88\u544A\u8B66\u4FE1\u606F</span>
etcdctl --endpoints<span class="token operator">=</span>http://127.0.0.1:2379 alarm disarm
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>\u7136\u540E\u518D\u6B21\u67E5\u770B\u72B6\u6001\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl --endpoints<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:2379&quot;</span> --write-out<span class="token operator">=</span>table endpoint status
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
<span class="token operator">|</span>       ENDPOINT        <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span>
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
<span class="token operator">|</span> http://127.0.0.1:2379 <span class="token operator">|</span> 8e9e05c52164694d <span class="token operator">|</span>  <span class="token number">3.3</span>.11 <span class="token operator">|</span>  <span class="token number">1.1</span> MB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>         <span class="token number">3</span> <span class="token operator">|</span>         <span class="token number">21</span> <span class="token operator">|</span>
+-----------------------+------------------+---------+---------+-----------+-----------+------------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>\u9A8C\u8BC1\u5199\u5165\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl put eryajf <span class="token builtin class-name">test</span>
OK
$ <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl get eryajf
eryajf
<span class="token builtin class-name">test</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u670D\u52A1\u6B63\u5E38\u4E86\u3002</p><p><img src="http://t.eryajf.net/imgs/2021/09/a8d9a13738180ac1.jpg" alt=""></p><h2 id="_4-systemd-\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#_4-systemd-\u7BA1\u7406" aria-hidden="true">#</a> 4\uFF0Csystemd \u7BA1\u7406</h2><p>\u901A\u5E38\u6211\u4EEC\u4F7F\u7528 systemd \u7BA1\u7406\u670D\u52A1\uFF0C\u4E8E\u662F\u53EF\u4EE5\u5728\u542F\u52A8\u7684\u65F6\u5019\u52A0\u5165\u914D\u7F6E\u4FE1\u606F\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$cat</span> /etc/systemd/system/etcd.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token assign-left variable">Before</span><span class="token operator">=</span>flanneld.service
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">User</span><span class="token operator">=</span>root
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/etcd  -name etcd1 -data-dir /var/lib/etcd  --advertise-client-urls http://10.3.7.7:2379,http://127.0.0.1:2379 --listen-client-urls http://10.3.7.7:2379,http://127.0.0.1:2379 --auto-compaction-retention<span class="token operator">=</span><span class="token number">1</span> --quota-backend-bytes<span class="token operator">=</span><span class="token number">8388608000</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><code>auto-compaction-retention</code>\uFF1A\u8868\u793A\u6BCF\u9694\u4E00\u4E2A\u5C0F\u65F6\u81EA\u52A8\u538B\u7F29\u4E00\u6B21</li><li><code>quota-backend-bytes</code>\uFF1A\u78C1\u76D8\u7A7A\u95F4\u8C03\u6574\u4E3A 8G\uFF0C\u5B98\u65B9\u5EFA\u8BAE\u6700\u5927 8G\u3002</li></ul><p>\u7136\u540E\u91CD\u542F\u5373\u53EF\u3002</p><p>\u53C2\u8003\uFF1Ahttps://etcd.io/docs/v3.4/faq/#what-does-mvcc-database-space-exceeded-mean-and-how-do-i-fix-it</p>`,36);function p(t,o){return e}var c=a(n,[["render",p]]);export{c as default};

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.29">
    <link rel="icon" href="/img/memo-favicon.ico"><title>手动搭建k8s-1-10-4之一键部署脚本 | Memo</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="modulepreload" href="./assets/app.dbf5d933.js"><link rel="modulepreload" href="./assets/2231.html.fa291296.js"><link rel="modulepreload" href="./assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="./assets/2231.html.1c4d881f.js">
    <link rel="stylesheet" href="./assets/style.9ca9d938.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/./pages/" class=""><!----><span class="site-name can-hide">Memo</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/./" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./topic/pages/2351.html" class="nav-link" aria-label="ELK"><!--[--><!--]--> ELK <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/1742.html" class="nav-link" aria-label="K8S"><!--[--><!--]--> K8S <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/45c5da/" class="nav-link" aria-label="Nexus"><!--[--><!--]--> Nexus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/2415.html" class="nav-link" aria-label="Jenkins"><!--[--><!--]--> Jenkins <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/220101204130/" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/22020104155458/" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./weekly/pages/11c668/" class="nav-link" aria-label="2021"><!--[--><!--]--> 2021 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./weekly/pages/220103181312/" class="nav-link" aria-label="2022"><!--[--><!--]--> 2022 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./code/pages/aeab08/" class="nav-link" aria-label="Golang"><!--[--><!--]--> Golang <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/5164.html" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/531.html" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./ops/pages/027a17/" class="nav-link" aria-label="最佳实践"><!--[--><!--]--> 最佳实践 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/29.html" class="nav-link" aria-label="迎刃而解"><!--[--><!--]--> 迎刃而解 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/930.html" class="nav-link" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2782.html" class="nav-link" aria-label="Php"><!--[--><!--]--> Php <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/596.html" class="nav-link" aria-label="Zabbix"><!--[--><!--]--> Zabbix <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2468.html" class="nav-link" aria-label="Prometheus"><!--[--><!--]--> Prometheus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5380.html" class="nav-link" aria-label="Grafana"><!--[--><!--]--> Grafana <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5279.html" class="nav-link" aria-label="CentOS"><!--[--><!--]--> CentOS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/1847.html" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5173.html" class="nav-link" aria-label="Ansible"><!--[--><!--]--> Ansible <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/3410.html" class="nav-link" aria-label="Ldap"><!--[--><!--]--> Ldap <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202208241125/" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2951.html" class="nav-link" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202209081510" class="nav-link" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/4050.html" class="nav-link" aria-label="Etcd"><!--[--><!--]--> Etcd <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/285.html" class="nav-link" aria-label="Other"><!--[--><!--]--> Other <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./blog/pages/211229105530.html" class="nav-link" aria-label="博客相关"><!--[--><!--]--> 博客相关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/eryajf/eryajf.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/./" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./topic/pages/2351.html" class="nav-link" aria-label="ELK"><!--[--><!--]--> ELK <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/1742.html" class="nav-link" aria-label="K8S"><!--[--><!--]--> K8S <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/45c5da/" class="nav-link" aria-label="Nexus"><!--[--><!--]--> Nexus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/2415.html" class="nav-link" aria-label="Jenkins"><!--[--><!--]--> Jenkins <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/220101204130/" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/22020104155458/" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./weekly/pages/11c668/" class="nav-link" aria-label="2021"><!--[--><!--]--> 2021 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./weekly/pages/220103181312/" class="nav-link" aria-label="2022"><!--[--><!--]--> 2022 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./code/pages/aeab08/" class="nav-link" aria-label="Golang"><!--[--><!--]--> Golang <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/5164.html" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/531.html" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./ops/pages/027a17/" class="nav-link" aria-label="最佳实践"><!--[--><!--]--> 最佳实践 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/29.html" class="nav-link" aria-label="迎刃而解"><!--[--><!--]--> 迎刃而解 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/930.html" class="nav-link" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2782.html" class="nav-link" aria-label="Php"><!--[--><!--]--> Php <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/596.html" class="nav-link" aria-label="Zabbix"><!--[--><!--]--> Zabbix <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2468.html" class="nav-link" aria-label="Prometheus"><!--[--><!--]--> Prometheus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5380.html" class="nav-link" aria-label="Grafana"><!--[--><!--]--> Grafana <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5279.html" class="nav-link" aria-label="CentOS"><!--[--><!--]--> CentOS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/1847.html" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5173.html" class="nav-link" aria-label="Ansible"><!--[--><!--]--> Ansible <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/3410.html" class="nav-link" aria-label="Ldap"><!--[--><!--]--> Ldap <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202208241125/" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2951.html" class="nav-link" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202209081510" class="nav-link" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/4050.html" class="nav-link" aria-label="Etcd"><!--[--><!--]--> Etcd <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/285.html" class="nav-link" aria-label="Other"><!--[--><!--]--> Other <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./blog/pages/211229105530.html" class="nav-link" aria-label="博客相关"><!--[--><!--]--> 博客相关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/eryajf/eryajf.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="_1-简单说明。" tabindex="-1"><a class="header-anchor" href="#_1-简单说明。" aria-hidden="true">#</a> 1，简单说明。</h2><p>此脚本所能够成形于今日，完全是拜大神分享的 https://github.com/opsnull/follow-me-install-kubernetes-cluster 项目所依托而成。之前也曾想过对 k8s 熟悉之后做一下部署脚本，但那时候并没有什么多么好的思路，直到上周看到了如上开源项目的部署思路，让我有种拨云见日，豁然开朗的感觉，当我跟随项目学习的时候，就已经打算了要写一下部署小脚本了。</p><p>因此，这个脚本基本上可以说是大神项目流程的一个堆叠，自己则只不过是做了一点点小小的整理与调试罢了，<strong>再一次，郑重的，对此表示感谢！</strong></p><p>当然啦，事实上当自己来整理这个脚本的时候发现，事情也并没有那么的简单，而写脚本的不简单，则是为了以后每次部署的更简单。</p><p>这里简单说明一下我使用的服务器情况：</p><p>服务器均采用 CentOS7.3 版本，未在其他系统版本中进行测试。</p><table><thead><tr><th>主机</th><th>主机名</th><th>组件</th></tr></thead><tbody><tr><td>192.168.111.3</td><td>kube-node1</td><td>Kubernetes 1.10.4,Docker 18.03.1-ce,Etcd 3.3.7,Flanneld 0.10.0,kube-apiserver,kube-controller-manager,kube-scheduler,kubelet,kube-proxy</td></tr><tr><td>192.168.111.4</td><td>kube-node2</td><td>同上</td></tr><tr><td>192.168.111.5</td><td>kube-node3</td><td>同上</td></tr></tbody></table><h2 id="_2-准备工作。" tabindex="-1"><a class="header-anchor" href="#_2-准备工作。" aria-hidden="true">#</a> 2，准备工作。</h2><p>首先将整个部署文件上传到部署服务器，进行解压，然后做以下准备工作。</p><p>其中脚本代码，我已上传到 GitHub，各位可以参考：</p><p>::: cardList 1</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> magic<span class="token punctuation">-</span>of<span class="token punctuation">-</span>kubernetes<span class="token punctuation">-</span>scripts
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> k8s集群一键部署脚本
  <span class="token key atrule">avatar</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//avatars2.githubusercontent.com/u/416130<span class="token punctuation">?</span>s=460<span class="token important">&amp;u=8753e86600e300a9811cdc539aa158deec2e2724&amp;v=4</span> <span class="token comment"># 可选</span>
  <span class="token key atrule">link</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/eryajf/magic<span class="token punctuation">-</span>of<span class="token punctuation">-</span>kubernetes<span class="token punctuation">-</span>scripts <span class="token comment"># 可选</span>
  <span class="token key atrule">bgColor</span><span class="token punctuation">:</span> <span class="token string">&#39;#FBDE4B&#39;</span> <span class="token comment"># 可选，默认var(--bodyBg)。颜色值有#号时请添加单引号</span>
  <span class="token key atrule">textColor</span><span class="token punctuation">:</span> <span class="token string">&#39;#fff&#39;</span> <span class="token comment"># 可选，默认var(--textColor)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>:::</p><p>整个安装包我已打包并上传百度云，可自行下载。</p><p>提取码通过如下方式获得：</p><ul><li><p>下载地址：<a href="https://pan.baidu.com/s/1JbICafwEdIwHnsDlGvPIMw" target="_blank" rel="noopener noreferrer">https://pan.baidu.com/s/1JbICafwEdIwHnsDlGvPIMw<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p></li><li><p>提取码: 4iaq</p></li></ul><h3 id="_1-修改以下内容。" tabindex="-1"><a class="header-anchor" href="#_1-修改以下内容。" aria-hidden="true">#</a> 1，修改以下内容。</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>config/environment.sh <span class="token comment">#修改ip为自己将要部署的机器ip</span>
config/Kcsh/hosts  <span class="token comment">#修改ip为自己将要部署的机器ip</span>
config/Ketcd/etcd-csr.json <span class="token comment">#修改ip为自己将要部署的机器ip</span>
config/Kmaster/Kha/haproxy.cfg <span class="token comment">#修改ip为自己将要部署的机器ip</span>
config/Kmaster/Kapi/kubernetes-csr.json <span class="token comment">#修改ip为自己将要部署的机器ip</span>
config/Kmaster/Kmanage/kube-controller-manager-csr.json <span class="token comment">#修改ip为自己将要部署的机器ip</span>
config/Kmaster/Kscheduler/kube-scheduler-csr.json <span class="token comment">#修改ip为自己将要部署的机器ip</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-基础配置。" tabindex="-1"><a class="header-anchor" href="#_2-基础配置。" aria-hidden="true">#</a> 2，基础配置。</h3><p>这些操作均在 kube-node1 主机上执行。</p><p><code>注意：</code>请严格按照如下这几步操作进行，否则可能导致下边部署脚本无法正常走完。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ssh-keygen
ssh-copy-id <span class="token number">192.168</span>.111.3
ssh-copy-id <span class="token number">192.168</span>.111.4
ssh-copy-id <span class="token number">192.168</span>.111.5
<span class="token function">scp</span> config/Kcsh/hosts root@192.168.111.3:/etc/hosts
<span class="token function">scp</span> config/Kcsh/hosts root@192.168.111.4:/etc/hosts
<span class="token function">scp</span> config/Kcsh/hosts root@192.168.111.5:/etc/hosts
<span class="token function">ssh</span> root@kube-node1 <span class="token string">&quot;hostnamectl set-hostname kube-node1&quot;</span>
<span class="token function">ssh</span> root@kube-node2 <span class="token string">&quot;hostnamectl set-hostname kube-node2&quot;</span>
<span class="token function">ssh</span> root@kube-node3 <span class="token string">&quot;hostnamectl set-hostname kube-node3&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_3-正式部署。" tabindex="-1"><a class="header-anchor" href="#_3-正式部署。" aria-hidden="true">#</a> 3，正式部署。</h2><p>部署非常简单，直接执行<code>magic.sh</code>脚本即可。</p><p>不过有几点需要做一下简单说明：</p><ul><li>1，启动正式部署之前，务必仔细认真检查各处配置是否与所需求的相匹配了，若不匹配，应当调整。</li><li>2，部署过程中如果有卡壳，或者未正常部署而退出，请根据对应的部署阶段进行排查，然后重新执行部署脚本，即可进行接续部署。</li><li>3，如对脚本中一些不足地方有任何建议，欢迎与我提出，一起维护，共同进步！</li></ul><h2 id="_4-简单验证。" tabindex="-1"><a class="header-anchor" href="#_4-简单验证。" aria-hidden="true">#</a> 4，简单验证。</h2><p>部署完成之后，可使用如下方式进行一些对集群可用性的初步检验：</p><h3 id="_1-检查服务是否均已正常启动。" tabindex="-1"><a class="header-anchor" href="#_1-检查服务是否均已正常启动。" aria-hidden="true">#</a> 1，检查服务是否均已正常启动。</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment">#author:eryajf</span>
<span class="token comment">#blog:wiki.eryajf.net</span>
<span class="token comment">#time:2018-11</span>
<span class="token comment">#</span>
<span class="token builtin class-name">set</span> -e
<span class="token builtin class-name">source</span> /opt/k8s/bin/environment.sh
<span class="token comment">#</span>
<span class="token comment">##set color##</span>
<span class="token function-name function">echoRed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token builtin class-name">echo</span> <span class="token string"><!--vuepress-ssr-app-->#39;<span class="token entity" title="\e">\e</span>[0;31m&#39;</span>&quot;<span class="token variable">$1</span><span class="token string">&quot;<!--vuepress-ssr-app-->#39;<span class="token entity" title="\e">\e</span>[0m&#39;; }
echoGreen() { echo <!--vuepress-ssr-app-->#39;<span class="token entity" title="\e">\e</span>[0;32m&#39;&quot;</span><span class="token variable">$1</span><span class="token string">&quot;<!--vuepress-ssr-app-->#39;<span class="token entity" title="\e">\e</span>[0m&#39;; }
echoYellow() { echo <!--vuepress-ssr-app-->#39;<span class="token entity" title="\e">\e</span>[0;33m&#39;&quot;</span><span class="token variable">$1</span><span class="token string">&quot;<!--vuepress-ssr-app-->#39;<span class="token entity" title="\e">\e</span>[0m&#39;; }
##set color##
#
for node_ip in <span class="token variable">${NODE_IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
do
    echoGreen &quot;</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">${node_ip}</span><span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status etcd<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status flanneld<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status haproxy<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status keepalived<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status kube-apiserver <span class="token operator">|</span><span class="token function">grep</span> <span class="token string">&#39;Active:&#39;</span><span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status kube-controller-manager<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status kube-scheduler<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status docker<span class="token operator">|</span><span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status kubelet <span class="token operator">|</span> <span class="token function">grep</span> Active<span class="token string">&quot;
    ssh root@<span class="token variable">${node_ip}</span> &quot;</span>systemctl status kube-proxy<span class="token operator">|</span><span class="token function">grep</span> Active&quot;
<span class="token keyword">done</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_2-查看相关服务可用性。" tabindex="-1"><a class="header-anchor" href="#_2-查看相关服务可用性。" aria-hidden="true">#</a> 2，查看相关服务可用性。</h3><h4 id="_1-验证-etcd-集群可用性。" tabindex="-1"><a class="header-anchor" href="#_1-验证-etcd-集群可用性。" aria-hidden="true">#</a> 1，验证 etcd 集群可用性。</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot; 
    ETCDCTL_API=3 /opt/k8s/bin/etcdctl \
    --endpoints=https://${node_ip}:2379 \
    --cacert=/etc/kubernetes/cert/ca.pem \
    --cert=/etc/etcd/cert/etcd.pem \
    --key=/etc/etcd/cert/etcd-key.pem endpoint health
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_2-验证-flannel-网络。" tabindex="-1"><a class="header-anchor" href="#_2-验证-flannel-网络。" aria-hidden="true">#</a> 2，验证 flannel 网络。</h4><p>查看已分配的 Pod 子网段列表：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">source</span> /opt/k8s/bin/environment.sh
etcdctl <span class="token punctuation">\</span>
  --endpoints<span class="token operator">=</span><span class="token variable">${ETCD_ENDPOINTS}</span> <span class="token punctuation">\</span>
  --ca-file<span class="token operator">=</span>/etc/kubernetes/cert/ca.pem <span class="token punctuation">\</span>
  --cert-file<span class="token operator">=</span>/etc/flanneld/cert/flanneld.pem <span class="token punctuation">\</span>
  --key-file<span class="token operator">=</span>/etc/flanneld/cert/flanneld-key.pem <span class="token punctuation">\</span>
  <span class="token function">ls</span> <span class="token variable">${FLANNEL_ETCD_PREFIX}</span>/subnets
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>输出：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>/kubernetes/network/subnets/172.30.84.0-24
/kubernetes/network/subnets/172.30.8.0-24
/kubernetes/network/subnets/172.30.29.0-24
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>验证各节点能通过 Pod 网段互通：</p><p><code>注意其中的IP段换成自己的。</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot; 
    ssh ${node_ip} &quot;ping -c 1 172.30.8.0&quot;
    ssh ${node_ip} &quot;ping -c 1 172.30.29.0&quot;
    ssh ${node_ip} &quot;ping -c 1 172.30.84.0&quot;
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_3-高可用组件验证。" tabindex="-1"><a class="header-anchor" href="#_3-高可用组件验证。" aria-hidden="true">#</a> 3，高可用组件验证。</h4><p>查看 VIP 所在的节点，确保可以 ping 通 VIP：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot; 
    ssh ${node_ip} &quot;/usr/sbin/ip addr show ${VIP_IF}&quot;
    ssh ${node_ip} &quot;ping -c 1 ${MASTER_VIP}&quot;
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_4-高可用性试验。" tabindex="-1"><a class="header-anchor" href="#_4-高可用性试验。" aria-hidden="true">#</a> 4，高可用性试验。</h4><p>查看当前的 leader：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$kubectl</span> get endpoints kube-controller-manager --namespace<span class="token operator">=</span>kube-system  -o yaml
apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: <span class="token string">&#39;{&quot;holderIdentity&quot;:&quot;kube-node1_444fbc06-f3d8-11e8-8ca8-0050568f514f&quot;,&quot;leaseDurationSeconds&quot;:15,&quot;acquireTime&quot;:&quot;2018-11-29T13:11:21Z&quot;,&quot;renewTime&quot;:&quot;2018-11-29T13:48:10Z&quot;,&quot;leaderTransitions&quot;:0}&#39;</span>
  creationTimestamp: <span class="token number">2018</span>-11-29T13:11:21Z
  name: kube-controller-manager
  namespace: kube-system
  resourceVersion: <span class="token string">&quot;3134&quot;</span>
  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager
  uid: 4452bff1-f3d8-11e8-a5a6-0050568fef9b
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可见，当前的 leader 为 kube-node1 节点。</p><p>现在停掉 kube-node1 上的 kube-controller-manager。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$systemctl</span> stop kube-controller-manager
<span class="token variable">$systemctl</span> status kube-controller-manager <span class="token operator">|</span><span class="token function">grep</span> Active
   Active: inactive <span class="token punctuation">(</span>dead<span class="token punctuation">)</span> since Sat <span class="token number">2018</span>-11-24 00:52:53 CST<span class="token punctuation">;</span> 44s ago
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>大概一分钟后，再查看一下当前的 leader：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$kubectl</span> get endpoints kube-controller-manager --namespace<span class="token operator">=</span>kube-system  -o yaml
apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: <span class="token string">&#39;{&quot;holderIdentity&quot;:&quot;kube-node3_45525ae6-f3d8-11e8-a2b8-0050568fbcaa&quot;,&quot;leaseDurationSeconds&quot;:15,&quot;acquireTime&quot;:&quot;2018-11-29T13:49:28Z&quot;,&quot;renewTime&quot;:&quot;2018-11-29T13:49:28Z&quot;,&quot;leaderTransitions&quot;:1}&#39;</span>
  creationTimestamp: <span class="token number">2018</span>-11-29T13:11:21Z
  name: kube-controller-manager
  namespace: kube-system
  resourceVersion: <span class="token string">&quot;3227&quot;</span>
  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager
  uid: 4452bff1-f3d8-11e8-a5a6-0050568fef9b
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以看到已经自动漂移到 kube-node3 上去了。</p><h4 id="_5-查验-kube-proxy-功能。" tabindex="-1"><a class="header-anchor" href="#_5-查验-kube-proxy-功能。" aria-hidden="true">#</a> 5，查验 kube-proxy 功能。</h4><p>查看 ipvs 路由规则</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot; 
    ssh root@${node_ip} &quot;/usr/sbin/ipvsadm -ln&quot;
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>输出：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$bash</span> magic.sh
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.120
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.254</span>.0.1:443 rr persistent <span class="token number">10800</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.120:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.121:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.122:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.121
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.254</span>.0.1:443 rr persistent <span class="token number">10800</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.120:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.121:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.122:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.122
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.254</span>.0.1:443 rr persistent <span class="token number">10800</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.120:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.121:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.111.122:6443         Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_6-创建一个应用。" tabindex="-1"><a class="header-anchor" href="#_6-创建一个应用。" aria-hidden="true">#</a> 6，创建一个应用。</h4><p>查看集群节点：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$kubectl</span> get node
NAME         STATUS    ROLES     AGE       VERSION
kube-node1   Ready     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>    45m       v1.10.4
kube-node2   Ready     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>    45m       v1.10.4
kube-node3   Ready     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>    45m       v1.10.4
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建测试应用：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> nginx-ds.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-ds
  labels:
    app: nginx-ds
spec:
  type: NodePort
  selector:
    app: nginx-ds
  ports:
  - name: http
    port: 80
    targetPort: 80
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: nginx-ds
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  template:
    metadata:
      labels:
        app: nginx-ds
    spec:
      containers:
      - name: my-nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>执行定义文件，启动之前，可以先将上边定义的镜像 pull 下来。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create -f nginx-ds.yml
<span class="token function">service</span> <span class="token string">&quot;nginx-ds&quot;</span> created
daemonset.extensions <span class="token string">&quot;nginx-ds&quot;</span> created
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>检查各 Node 上的 Pod IP 连通性</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$kubectl</span> get pods  -o wide<span class="token operator">|</span><span class="token function">grep</span> nginx-ds
nginx-ds-78lqz   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          2m        <span class="token number">172.30</span>.87.2   kube-node3
nginx-ds-j45zf   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          2m        <span class="token number">172.30</span>.99.2   kube-node2
nginx-ds-xhttt   <span class="token number">1</span>/1       Running   <span class="token number">0</span>          2m        <span class="token number">172.30</span>.55.2   kube-node1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可见，nginx-ds 的 Pod IP 分别是 172.30.84.2、172.30.8.2、172.30.29.2，在所有 Node 上分别 ping 这三个 IP，看是否连通：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot;
    ssh ${node_ip} &quot;ping -c 1 172.30.87.2&quot;
    ssh ${node_ip} &quot;ping -c 1 172.30.99.2&quot;
    ssh ${node_ip} &quot;ping -c 1 172.30.55.2&quot;
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>检查服务 IP 和端口可达性</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token variable">$kubectl</span> get svc <span class="token operator">|</span><span class="token function">grep</span> nginx-ds
nginx-ds           NodePort    <span class="token number">10.254</span>.110.153   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:8781/TCP      6h
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在所有 Node 上 curl Service IP：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot; 
    ssh ${node_ip} &quot;curl 10.254.128.98&quot;
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>检查服务的 NodePort 可达性</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> magic.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
do
    echo &quot;&gt;&gt;&gt; ${node_ip}&quot; 
    ssh ${node_ip} &quot;curl ${node_ip}:8996&quot;
done
EOF</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/eryajf/eryajf.github.io/edit/main/02.系列专题/101.Kubernetes笔记/03.手动搭建k8s-1-10-4高可用集群(推荐版).md/20.手动搭建k8s-1-10-4之一键部署脚本.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: fengxuechao@tal.com">fengxuechao</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="./assets/app.dbf5d933.js" defer></script>
  </body>
</html>

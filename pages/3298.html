<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.29">
    <link rel="icon" href="/img/memo-favicon.ico"><title>Jenkinsfile声明式语法详解 | Memo</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="modulepreload" href="./assets/app.dbf5d933.js"><link rel="modulepreload" href="./assets/3298.html.a5c1801a.js"><link rel="modulepreload" href="./assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="./assets/3298.html.33ac6f7b.js">
    <link rel="stylesheet" href="./assets/style.9ca9d938.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/./pages/" class=""><!----><span class="site-name can-hide">Memo</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/./" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./topic/pages/2351.html" class="nav-link" aria-label="ELK"><!--[--><!--]--> ELK <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/1742.html" class="nav-link" aria-label="K8S"><!--[--><!--]--> K8S <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/45c5da/" class="nav-link" aria-label="Nexus"><!--[--><!--]--> Nexus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/2415.html" class="nav-link" aria-label="Jenkins"><!--[--><!--]--> Jenkins <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/220101204130/" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/22020104155458/" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./weekly/pages/11c668/" class="nav-link" aria-label="2021"><!--[--><!--]--> 2021 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./weekly/pages/220103181312/" class="nav-link" aria-label="2022"><!--[--><!--]--> 2022 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./code/pages/aeab08/" class="nav-link" aria-label="Golang"><!--[--><!--]--> Golang <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/5164.html" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/531.html" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./ops/pages/027a17/" class="nav-link" aria-label="最佳实践"><!--[--><!--]--> 最佳实践 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/29.html" class="nav-link" aria-label="迎刃而解"><!--[--><!--]--> 迎刃而解 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/930.html" class="nav-link" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2782.html" class="nav-link" aria-label="Php"><!--[--><!--]--> Php <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/596.html" class="nav-link" aria-label="Zabbix"><!--[--><!--]--> Zabbix <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2468.html" class="nav-link" aria-label="Prometheus"><!--[--><!--]--> Prometheus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5380.html" class="nav-link" aria-label="Grafana"><!--[--><!--]--> Grafana <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5279.html" class="nav-link" aria-label="CentOS"><!--[--><!--]--> CentOS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/1847.html" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5173.html" class="nav-link" aria-label="Ansible"><!--[--><!--]--> Ansible <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/3410.html" class="nav-link" aria-label="Ldap"><!--[--><!--]--> Ldap <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202208241125/" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2951.html" class="nav-link" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202209081510" class="nav-link" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/4050.html" class="nav-link" aria-label="Etcd"><!--[--><!--]--> Etcd <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/285.html" class="nav-link" aria-label="Other"><!--[--><!--]--> Other <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./blog/pages/211229105530.html" class="nav-link" aria-label="博客相关"><!--[--><!--]--> 博客相关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/eryajf/eryajf.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/./" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./topic/pages/2351.html" class="nav-link" aria-label="ELK"><!--[--><!--]--> ELK <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/1742.html" class="nav-link" aria-label="K8S"><!--[--><!--]--> K8S <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/45c5da/" class="nav-link" aria-label="Nexus"><!--[--><!--]--> Nexus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/2415.html" class="nav-link" aria-label="Jenkins"><!--[--><!--]--> Jenkins <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/220101204130/" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/22020104155458/" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./weekly/pages/11c668/" class="nav-link" aria-label="2021"><!--[--><!--]--> 2021 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./weekly/pages/220103181312/" class="nav-link" aria-label="2022"><!--[--><!--]--> 2022 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./code/pages/aeab08/" class="nav-link" aria-label="Golang"><!--[--><!--]--> Golang <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/5164.html" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/531.html" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./ops/pages/027a17/" class="nav-link" aria-label="最佳实践"><!--[--><!--]--> 最佳实践 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/29.html" class="nav-link" aria-label="迎刃而解"><!--[--><!--]--> 迎刃而解 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/930.html" class="nav-link" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2782.html" class="nav-link" aria-label="Php"><!--[--><!--]--> Php <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/596.html" class="nav-link" aria-label="Zabbix"><!--[--><!--]--> Zabbix <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2468.html" class="nav-link" aria-label="Prometheus"><!--[--><!--]--> Prometheus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5380.html" class="nav-link" aria-label="Grafana"><!--[--><!--]--> Grafana <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5279.html" class="nav-link" aria-label="CentOS"><!--[--><!--]--> CentOS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/1847.html" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5173.html" class="nav-link" aria-label="Ansible"><!--[--><!--]--> Ansible <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/3410.html" class="nav-link" aria-label="Ldap"><!--[--><!--]--> Ldap <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202208241125/" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2951.html" class="nav-link" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202209081510" class="nav-link" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/4050.html" class="nav-link" aria-label="Etcd"><!--[--><!--]--> Etcd <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/285.html" class="nav-link" aria-label="Other"><!--[--><!--]--> Other <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./blog/pages/211229105530.html" class="nav-link" aria-label="博客相关"><!--[--><!--]--> 博客相关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/eryajf/eryajf.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>上篇文章对Jenkins pipeline入门做了简单介绍，简单见识了Jenkinsfile当中的几个常用的语法关键字，本文将针对声明式的语法进行详细解读，这种解读将会是手册性质的，会有讲解，必要的也会有简单实验演示，但是并不会做完整项目流程的介绍。</p><p>手册性质的整理，是为了方便以后用起来之后，查询方便。我个人也常常因为遇到一些陌生的参数，或者不熟悉的用法，到网上各种找，检索到的结果往往也都不十分满意，因此这篇文章，会尽量详细记录各个指令的参数项。</p><h2 id="_1-框架介绍。" tabindex="-1"><a class="header-anchor" href="#_1-框架介绍。" aria-hidden="true">#</a> 1，框架介绍。</h2><p>一个常规的声明式Jenkinsfile，一般情况下，有如下常规框架，这个框架基本上每个环节都是必不可少的，所以我就从外到内，先从整体框架讲起。图示如下：</p><p><img src="http://t.eryajf.net/imgs/2021/09/f126d7d667e038cd.jpg" alt="image-20200111205506591"></p><p>而当我们在vscode当中安装了Jenkins pipeline插件的之后，输入pipe然后回车，默认自动补全出来的内容如下：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline<span class="token punctuation">{</span>
    agent<span class="token punctuation">{</span>
        label <span class="token string gstring">&quot;node&quot;</span>
    <span class="token punctuation">}</span>
    stages<span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            steps<span class="token punctuation">{</span>
                echo <span class="token string gstring">&quot;========executing A========&quot;</span>
            <span class="token punctuation">}</span>
            post<span class="token punctuation">{</span>
                always<span class="token punctuation">{</span>
                    echo <span class="token string gstring">&quot;========always========&quot;</span>
                <span class="token punctuation">}</span>
                success<span class="token punctuation">{</span>
                    echo <span class="token string gstring">&quot;========A executed successfully========&quot;</span>
                <span class="token punctuation">}</span>
                failure<span class="token punctuation">{</span>
                    echo <span class="token string gstring">&quot;========A execution failed========&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    post<span class="token punctuation">{</span>
        always<span class="token punctuation">{</span>
            echo <span class="token string gstring">&quot;========always========&quot;</span>
        <span class="token punctuation">}</span>
        success<span class="token punctuation">{</span>
            echo <span class="token string gstring">&quot;========pipeline executed successfully ========&quot;</span>
        <span class="token punctuation">}</span>
        failure<span class="token punctuation">{</span>
            echo <span class="token string gstring">&quot;========pipeline execution failed========&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>现在就基于这个基础框架，介绍一下各个组件，因为这些在上篇文章基本上都介绍过，所以略人所详地进行一下讲解。</p><h3 id="_1-pipeline。" tabindex="-1"><a class="header-anchor" href="#_1-pipeline。" aria-hidden="true">#</a> 1，pipeline。</h3><p>用于声明表示流水线的标识，表示这里将采用声明式的语法风格。并不包含什么特殊意义。</p><h3 id="_2-anget。" tabindex="-1"><a class="header-anchor" href="#_2-anget。" aria-hidden="true">#</a> 2，anget。</h3><p>此关键字用于表示当前流水线将要执行的位置，当我们的Jenkins是主从那种集群的时候，可以通过agent进行指定，同时也可以基于docker容器的构建，因为现在一切都是容器化的时代，所以这里就基于容器的这种方式稍微展开讲一下，介绍一下用法，以后可能会专门用一篇文章展开详解一下妙用。</p><h4 id="_1-常规用法。" tabindex="-1"><a class="header-anchor" href="#_1-常规用法。" aria-hidden="true">#</a> 1，常规用法。</h4><p>日常构建部署中，常常会用到编译工作，因此这里的步骤可以放入到镜像中执行，这里利用node项目的编译举一个示例：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent <span class="token punctuation">{</span>
        docker <span class="token punctuation">{</span>
        		lable <span class="token string">&#39;docker&#39;</span>
            image <span class="token string">&#39;registry.cn-hangzhou.aliyuncs.com/eryajf/node:11.15&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            steps <span class="token punctuation">{</span>
                sh <span class="token string">&#39;npm install --registry=https://registry.npm.taobao.org&#39;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>当流水线执行的时候，Jenkins会首先将代码更新，然后将 <code>$WORKSPACE</code> 挂载到容器之中，这个可以通过构建日志中看出来：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>docker run -t -d -u <span class="token number">0</span>:0 -w /root/.jenkins/workspace/test-pinpeline -v /root/.jenkins/workspace/test-pinpeline:/root/.jenkins/workspace/test-pinpeline:rw,z -v /root/.jenkins/workspace/test-pinpeline@tmp:/root/.jenkins/workspace/test-pinpeline@tmp:rw,z -e ******** registry.cn-hangzhou.aliyuncs.com/eryajf/node:11.15
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>接着执行我们定义的install编译命令，当然，下边可以继续添加步骤，将代码rsync到远程主机，或者其他操作。</p><p>此处可用的参数如下：</p><ul><li>lable（可选）：定义一个标签，用处不十分大。</li><li>image：定义构建时使用的镜像。</li><li>args：可以定义类似docker run命令时的一些参数。</li><li>alwaysPull：布尔类型，是否在每次运行的时候重新拉取镜像。</li></ul><h4 id="_2-添加参数。" tabindex="-1"><a class="header-anchor" href="#_2-添加参数。" aria-hidden="true">#</a> 2，添加参数。</h4><p>日常编译比较影响构建时间的一个因素是本地缓存，因此还可以用如下方式将本地缓存挂载到容器之中，从而加快构建速度。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent <span class="token punctuation">{</span>
        docker <span class="token punctuation">{</span>
            image <span class="token string">&#39;registry.cn-hangzhou.aliyuncs.com/eryajf/node:11.15&#39;</span>
            args <span class="token string">&#39;-v /root/.npm:/root/.npm&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            steps <span class="token punctuation">{</span>
                sh <span class="token string">&#39;npm install --registry=https://registry.npm.taobao.org&#39;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_3-多个容器。" tabindex="-1"><a class="header-anchor" href="#_3-多个容器。" aria-hidden="true">#</a> 3，多个容器。</h4><p>基于如上的事实，发散我们的思维，我们可以将许多个基础性的步骤，封装成一个又一个镜像，然后在每个步骤中只需调用封装好的镜像，传入所需的参数，即可完成比较复杂的构建。</p><p>多个容器用法，如下简示：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent none
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            agent <span class="token punctuation">{</span>
                docker <span class="token punctuation">{</span>
                    image <span class="token string">&#39;registry.cn-hangzhou.aliyuncs.com/eryajf/node:11.15&#39;</span>
                    args <span class="token string">&#39;-v /root/.npm:/root/.npm&#39;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            steps <span class="token punctuation">{</span>
                sh <span class="token string">&#39;npm install --registry=https://registry.npm.taobao.org&#39;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;deploy&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            agent <span class="token punctuation">{</span>
                docker <span class="token punctuation">{</span>
                    image <span class="token string">&#39;registry.cn-hangzhou.aliyuncs.com/mckj/ansible&#39;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            steps <span class="token punctuation">{</span>
                sh <span class="token string">&#39;echo &quot;通过ansbile进行部署&quot;&#39;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>因为Jenkins默认会将<code>$WORKSPACE</code>挂载到两个容器中，因此各种操作直接基于当前目录即可，这是值得注意的一点。</p><p>这里只是做一个演示，提供一种思路，以后有需要，可以借此发挥更多的妙用。</p><h4 id="_4-基于dockerfile。" tabindex="-1"><a class="header-anchor" href="#_4-基于dockerfile。" aria-hidden="true">#</a> 4，基于Dockerfile。</h4><p>这种方式，应用的大概比较少，仅做简单介绍。</p><p>首先在项目根目录创建一个Dockerfile：</p><div class="language-docker ext-docker line-numbers-mode"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span>       eryajf/centos:7.5</span>
<span class="token instruction"><span class="token keyword">MAINTAINER</span> eryajf &lt;Linuxlql@163.com&gt;</span>

<span class="token comment"># Install node</span>
<span class="token instruction"><span class="token keyword">ADD</span>  node-v11.15.0-linux-x64.tar.xz   /usr/local/</span>

<span class="token instruction"><span class="token keyword">ENV</span> NODE /usr/local/node-v11.15.0-linux-x64</span>
<span class="token instruction"><span class="token keyword">ENV</span> PATH <span class="token variable">$PATH</span>:<span class="token variable">$NODE</span>/bin</span>

<span class="token instruction"><span class="token keyword">RUN</span> npm i -g pm2 gulp yarn --registry=https://registry.npm.taobao.org</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后定义Jenkinsfile：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent <span class="token punctuation">{</span> dockerfile <span class="token boolean">true</span> <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            steps <span class="token punctuation">{</span>
                sh <span class="token string">&#39;npm install --registry=https://registry.npm.taobao.org&#39;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>感觉起来，这种方式引入了过多的不确定因素，对于构建稳定性，反而不是一件好事儿，所以不太推荐。</p><h3 id="_3-environment" tabindex="-1"><a class="header-anchor" href="#_3-environment" aria-hidden="true">#</a> 3，environment</h3><p>用于设置环境变量，以便于代码复用的时候，更加清晰明了的简化工作内容，只要项目是类似的，那么直接在 <code>environment</code>区域进行配置即可，而无需穿梭到复杂的内容里更改配置。需要注意的一点是，变量的声明可以在pipeline以及stage区域当中，与大多数语言一样，不同的区域作用域也是不一样的。</p><h3 id="_4-stages" tabindex="-1"><a class="header-anchor" href="#_4-stages" aria-hidden="true">#</a> 4，stages</h3><p>此关键字用于表示流水线各个步骤的声明，其下一层级是stage，stages部分至少包含一个stage。</p><h3 id="_5-stage" tabindex="-1"><a class="header-anchor" href="#_5-stage" aria-hidden="true">#</a> 5，stage</h3><p>表示实际构建的阶段，每个阶段做不同的事情，可按如上方式定义阶段的名称。</p><h3 id="_6-steps" tabindex="-1"><a class="header-anchor" href="#_6-steps" aria-hidden="true">#</a> 6，steps</h3><p>标识阶段之中具体的构建步骤，至少包含一个步骤，在stage中有且只能有一个steps。</p><h2 id="_2-主要参数。" tabindex="-1"><a class="header-anchor" href="#_2-主要参数。" aria-hidden="true">#</a> 2，主要参数。</h2><h3 id="_1-options" tabindex="-1"><a class="header-anchor" href="#_1-options" aria-hidden="true">#</a> 1，options</h3><p>用来配置Jenkins应用自身的一些配置项，常用的参数有如下，可根据自己的需求进行选用。</p><ul><li><p>buildDiscarder</p><p>保存最近历史构建记录的数量，比较熟悉Jenkins的童鞋应该明白这个参数的意义，可以有效控制Jenkins主机存储空间。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token comment">// 表示保留10次构建历史</span>
		<span class="token function">buildDiscarder</span><span class="token punctuation">(</span><span class="token function">logRotator</span><span class="token punctuation">(</span>numToKeepStr<span class="token punctuation">:</span> <span class="token string">&#39;10&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>disableConcurrentBuilds</p><p>不允许同时执行流水线，被用来防止同时访问共享资源等。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token function">disableConcurrentBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>timeout</p><p>设置项目构建超时时间，很明显，如果超时，将会以失败状态结束构建。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token comment">// 设置流水线运行的超过10分钟，Jenkins将中止流水线</span>
		<span class="token function">timeout</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> unit<span class="token punctuation">:</span> <span class="token string">&#39;MINUTES&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>同理还有小时(HOURS)和秒(SECONDS)，可根据实际项目需求进行定义。</p></li><li><p>timestamps</p><p>设置在项目打印日志时带上对应时间。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token comment">// 输出构建的时间信息</span>
    <span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>skipDefaultCheckout</p><p>在<code>agent</code> 指令中，跳过从源代码控制中检出代码的默认情况。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token comment">// 跳过默认的代码检出</span>
		<span class="token function">skipDefaultCheckout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>checkoutToSubdirectory</p><p>指定代码检出到 <code>$WORKSPACE</code>的子目录。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token function">checkoutToSubdirectory</span><span class="token punctuation">(</span><span class="token string">&#39;testdir&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>retry</p><p>在构建失败的时候，重新尝试整个流水线的指定次数。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token function">retry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul><p><code>常用汇总：</code></p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>options <span class="token punctuation">{</span>
		<span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">disableConcurrentBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">timeout</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> unit<span class="token punctuation">:</span> <span class="token string">&#39;MINUTES&#39;</span><span class="token punctuation">)</span>
    <span class="token function">buildDiscarder</span><span class="token punctuation">(</span><span class="token function">logRotator</span><span class="token punctuation">(</span>numToKeepStr<span class="token punctuation">:</span> <span class="token string">&#39;10&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_2-post" tabindex="-1"><a class="header-anchor" href="#_2-post" aria-hidden="true">#</a> 2，post</h3><p>用于定义在整个流水线执行结果的情况，通常可配合通知进行对项目构建状态的告知。有如下几种状态：</p><ul><li><p><code>always</code></p><p>无论流水线或阶段的完成状态如何，都允许在 <code>post</code> 部分运行该步骤。</p></li><li><p><code>changed</code></p><p>只有当前流水线或阶段的完成状态与它之前的运行不同时，才允许在 <code>post</code> 部分运行该步骤。</p></li><li><p><code>failure</code></p><p>只有当前流水线或阶段的完成状态为&quot;failure&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常web UI是红色。</p></li><li><p><code>success</code></p><p>只有当前流水线或阶段的完成状态为&quot;success&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常web UI是蓝色或绿色。</p></li><li><p><code>unstable</code></p><p>只有当前流水线或阶段的完成状态为&quot;unstable&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常由于测试失败,代码违规等造成。通常web UI是黄色。</p></li><li><p><code>aborted</code></p><p>只有当前流水线或阶段的完成状态为&quot;aborted&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常由于流水线被手动的aborted。通常web UI是灰色。</p></li></ul><p>关于这里，可以有比较巧妙的用法，后续可能也会专门列一篇文章来书写。</p><h3 id="_3-tools" tabindex="-1"><a class="header-anchor" href="#_3-tools" aria-hidden="true">#</a> 3，tools</h3><p>定义部署流程中常用的一些工具，这些工具在<code>管理Jenkins</code>---&gt;<code>Global Tool Configuration</code>中添加，然后在项目中引用。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    tools <span class="token punctuation">{</span>
        maven <span class="token string">&#39;maven&#39;</span> 
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Example&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                sh <span class="token string">&#39;mvn --version&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-parameters" tabindex="-1"><a class="header-anchor" href="#_4-parameters" aria-hidden="true">#</a> 4，parameters</h3><p>parameters 指令提供用户在触发 Pipeline 时应提供的参数列表，也就是在以往的free style风格中最常用到的参数化构建，我们不必在每次新建项目之后，一步一步在web界面中配置需要的参数，而是可以直接通过声明式进行参数化风格定义，这样极大简化了配置工作。</p><p>parameters 指令支持以下几种常用类型：</p><ul><li><p>string，字符串类型。</p><p>以往常常通过这个参数，来定义手动构建时输入将要构建的代码分支，那么这里可以用如下方式表达：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;branch&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;master&#39;</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;请输入将要构建的代码分支&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>注意：</code>这种声明定义之后，需要手动构建一次，然后配置就会自动落位到原来熟悉的参数化构建中了。</p></li><li><p>choice，选项参数类型。</p><p>以往经常会选用这个参数，用于指定构建的方向是部署还是回滚，多个参数有两种表达方式。</p><p><code>其一：</code></p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;mode&#39;</span><span class="token punctuation">,</span> choices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;deploy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rollback&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;选择方向！&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>其二：</code></p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;ENV_TYPE&#39;</span><span class="token punctuation">,</span> choices<span class="token punctuation">:</span> <span class="token string">&#39;test\n\pre\nprod&#39;</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;请选择部署的环境&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul><p>以上两种参数，做一个简单的配置实验，首先准备如下伪代码：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline<span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;branch&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;master&#39;</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;请输入将要构建的代码分支&#39;</span><span class="token punctuation">)</span>
        <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;mode&#39;</span><span class="token punctuation">,</span> choices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;deploy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;rollback&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;选择方向！&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;test&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps<span class="token punctuation">{</span>
                script <span class="token punctuation">{</span>
                    sh <span class="token string gstring">&quot;java -version&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>创建一个新的pipeline风格的项目，将如上代码填写进入，点击构建，然后参数就会落位到对应的位置了。</p><p><img src="http://t.eryajf.net/imgs/2021/09/fd909370e87f205f.jpg" alt="img"></p><p>接着继续介绍这里的参数。</p><ul><li><p>booleanParam，布尔值参数</p><p>就是定义一个布尔类型参数，用户可以在 Jenkins UI 上选择是还是否，选择是表示代码会执行这部分，如果选择否，会跳过这部分。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">booleanParam</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;DEBUG_BUILD&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>text，文本参数</p><p>文本（text）的参数就是支持写很多行的字符串。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">text</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;Deploy_text&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;One\nTwo\nThree\n&#39;</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>password，密码参数</p><p>密码（password）参数就是在 Jenkins 参数化构建 UI 提供一个暗文密码输入框，所有需要脱敏的信息，都可以通过这个参数来配置。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>Pipeline <span class="token punctuation">{</span>
    agent any
    parameters <span class="token punctuation">{</span>
        <span class="token function">password</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;PASSWORD&#39;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;SECRET&#39;</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">&#39;A secret password&#39;</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul><p>如上参数已经基本上可以满足日常需求，思路大概就是通过Jenkinsfile的配置，部署仍旧沿用以往常规的手动部署的方式，这种方式在高效率持续构建方面，似乎已经不大适合，所以以后可以与input参数配合使用，这里不展开，以后可专门列一篇文章来讲。</p><h3 id="_5-input" tabindex="-1"><a class="header-anchor" href="#_5-input" aria-hidden="true">#</a> 5，input</h3><p><code>stage</code> 的 <code>input</code> 指令允许你使用 <a href="https://jenkins.io/doc/pipeline/steps/pipeline-input-step/#input-wait-for-interactive-input" target="_blank" rel="noopener noreferrer"><code>input</code> step<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>提示输入。 在应用了 <code>options</code> 后，进入 <code>stage</code> 的 <code>agent</code> 或评估 <code>when</code> 条件前， <code>stage</code> 将暂停。 如果 <code>input</code> 被批准, <code>stage</code> 将会继续。 作为 <code>input</code> 提交的一部分的任何参数都将在环境中用于其他 <code>stage</code>。</p><p>一个成熟的input，大概需要如下几个要点：</p><ul><li><p>message</p><ul><li>必需的。 这将在用户提交 <code>input</code> 时作为说明信息呈现给用户。</li></ul></li><li><p>id</p><ul><li><code>input</code> 的可选标识符， 默认为 <code>stage</code> 名称。</li></ul></li><li><p>ok</p><ul><li>自定义确定按钮的文本信息。</li></ul></li><li><p>submitter</p><ul><li>可选的以逗号分隔的用户列表或允许提交 <code>input</code> 的外部组名。默认允许任何用户。</li></ul></li><li><p>submitterParameter</p><ul><li>环境变量的可选名称。如果存在，用 <code>submitter</code> 名称设置。</li></ul></li><li><p>parameters</p><ul><li>提示提交者提供的一个可选的参数列表，结合好了，会有非常多的妙用。</li></ul></li></ul><p>这里简单创建一个项目，用于一种思路的引导：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline<span class="token punctuation">{</span>
    agent any
    environment<span class="token punctuation">{</span>
    approvalMap <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;pre deploy&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            steps<span class="token punctuation">{</span>
                script<span class="token punctuation">{</span>
                    approvalMap <span class="token operator">=</span> input <span class="token punctuation">(</span>
                        message<span class="token punctuation">:</span> <span class="token string">&#39;准备发布到哪个环境？&#39;</span><span class="token punctuation">,</span>
                        ok<span class="token punctuation">:</span> <span class="token string">&#39;确定&#39;</span><span class="token punctuation">,</span>
                        parameters<span class="token punctuation">:</span><span class="token punctuation">[</span>
                            <span class="token function">choice</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;ENV&#39;</span><span class="token punctuation">,</span>choices<span class="token punctuation">:</span> <span class="token string">&#39;test\npre\nprod&#39;</span><span class="token punctuation">,</span>description<span class="token punctuation">:</span> <span class="token string">&#39;发布到什么环境？&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token function">string</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&#39;myparam&#39;</span><span class="token punctuation">,</span>defaultValue<span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>description<span class="token punctuation">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">]</span><span class="token punctuation">,</span>
                        submitter<span class="token punctuation">:</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">,</span>
                        submitterParameter<span class="token punctuation">:</span> <span class="token string">&#39;APPROVER&#39;</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;deploy&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            steps<span class="token punctuation">{</span>
                echo <span class="token string gstring">&quot;操作者是 <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>approvalMap<span class="token punctuation">[</span><span class="token string">&#39;APPROVER&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&quot;</span>
                echo <span class="token string gstring">&quot;发布到什么环境 <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>approvalMap<span class="token punctuation">[</span><span class="token string">&#39;ENV&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&quot;</span>
                echo <span class="token string gstring">&quot;自定义参数 <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>approvalMap<span class="token punctuation">[</span><span class="token string">&#39;myparam&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>点击构建，程序将会在input的步骤停住，等待用户进行相应输入，从而进行不同构建，当然，这里的多环境只是做了一个简单的打印，如果再结合上判断，以及不同分支构建，就能实现更加丰富的功能，不用着急，很快就会介绍Jenkinsfile中的判断了。</p><p><code>注意：</code>开头环境变量，先创建了一个空的名称，后边再将定义的参数结果赋值给开头的变量，这样便于后边调用，调用时直接引用这个Map类型即可。另外，因为这种赋值的方式属于Groovy语言的赋值方式，因此对应的赋值过程需要放在script块中。</p><h3 id="_6-when" tabindex="-1"><a class="header-anchor" href="#_6-when" aria-hidden="true">#</a> 6，when</h3><p><code>when</code> 指令允许流水线根据给定的条件决定是否应该执行阶段。 <code>when</code> 指令必须包含至少一个条件。 如果 <code>when</code> 指令包含多个条件, 所有的子条件必须返回True，阶段才能执行。</p><p>when指令有一些内置的条件判断关键字，这些关键字用好了，会给生产带来极大的效率提升，接下来就来认识一下这些关键字。</p><h4 id="_1-branch" tabindex="-1"><a class="header-anchor" href="#_1-branch" aria-hidden="true">#</a> 1，branch</h4><p>很明显，这个参数是针对于项目分值来做判断的，在配置多分支构建的场景下，使用会比较方便。比如结合上边input的场景，我们定义了一个字符参数，用于区别代码发布的分支与环境，不同的分支部署到不同的环境，原来的思路，大概是用if-else判断来实现。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;deploy to test&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    steps<span class="token punctuation">{</span>
        script<span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span>GIT_BRANCH <span class="token operator">==</span> <span class="token string">&#39;test&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                echo <span class="token string gstring">&quot;deploy to test env&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;deploy to prod&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    steps<span class="token punctuation">{</span>
        script<span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span>GIT_BRANCH <span class="token operator">==</span> <span class="token string">&#39;master&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                echo <span class="token string gstring">&quot;deploy to prod env&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>前边提到过，script是Groovy风格的语法，并不是本文推荐的风格，因此可以用when来代替上边的代码：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;deploy to test&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    when <span class="token punctuation">{</span>
        branch <span class="token string">&#39;test&#39;</span>
    <span class="token punctuation">}</span>
    steps<span class="token punctuation">{</span>
        echo <span class="token string gstring">&quot;deploy to test env&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;deploy to prod&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    when <span class="token punctuation">{</span>
        branch <span class="token string">&#39;master&#39;</span>
    <span class="token punctuation">}</span>
    steps<span class="token punctuation">{</span>
        echo <span class="token string gstring">&quot;deploy to prod env&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>注意：</code>这里的branch语法匹配，还支持通配符类型的，比如，<code>branch &#39;test.*&#39;</code>，表示匹配到以test开头的分支。</p><p>这种用法更多应用在多分支构建场景中，后边有机会将会专门用一篇文章来介绍。</p><h4 id="_2-environment" tabindex="-1"><a class="header-anchor" href="#_2-environment" aria-hidden="true">#</a> 2，environment</h4><p>同样也是一个判断，只不过判断的参数来源是环境变量的值，如果环境变量的值与我们定义的相同，则执行：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when<span class="token punctuation">{</span>
    environment name<span class="token punctuation">:</span> <span class="token string">&#39;ENV&#39;</span><span class="token punctuation">,</span>value<span class="token punctuation">:</span> <span class="token string">&#39;prod&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_3-not" tabindex="-1"><a class="header-anchor" href="#_3-not" aria-hidden="true">#</a> 3，not</h4><p>当嵌套条件是错误时，执行这个阶段，必须包含一个条件，例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
		not <span class="token punctuation">{</span> branch <span class="token string">&#39;master&#39;</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>判断环境条件时，用如下写法：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
		not <span class="token punctuation">{</span> environment name<span class="token punctuation">:</span> <span class="token string">&#39;mode&#39;</span><span class="token punctuation">,</span>value<span class="token punctuation">:</span> <span class="token string">&#39;deploy&#39;</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_4-allof" tabindex="-1"><a class="header-anchor" href="#_4-allof" aria-hidden="true">#</a> 4，allOf</h4><p>当所有的嵌套条件都正确时，才执行。例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
		allOf <span class="token punctuation">{</span> 
				branch <span class="token string">&#39;master&#39;</span><span class="token punctuation">;</span> 
				environment name<span class="token punctuation">:</span> <span class="token string">&#39;DEPLOY_TO&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">&#39;production&#39;</span> 
		<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_5-anyof" tabindex="-1"><a class="header-anchor" href="#_5-anyof" aria-hidden="true">#</a> 5，anyOf</h4><p>当至少有一个嵌套条件为真时，执行这个阶段，必须包含至少一个条件，例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
		anyOf <span class="token punctuation">{</span> 
				branch <span class="token string">&#39;master&#39;</span><span class="token punctuation">;</span> 
				branch <span class="token string">&#39;dev&#39;</span> 
		<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_6-beforeagent" tabindex="-1"><a class="header-anchor" href="#_6-beforeagent" aria-hidden="true">#</a> 6，beforeAgent</h4><p>正常情况下，程序都是自上而下执行的，也就是在agent之后才会执行when，但是某些场景中，可能我们需要先做一下判断，然后再进入到agent字段中的，那么这个时候，就需要用到beforeAgent。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent none
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Example Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;Hello World&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Example Deploy&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            agent <span class="token punctuation">{</span>
                label <span class="token string gstring">&quot;some-label&quot;</span>
            <span class="token punctuation">}</span>
            when <span class="token punctuation">{</span>
                beforeAgent <span class="token boolean">true</span>
                branch <span class="token string">&#39;production&#39;</span>
            <span class="token punctuation">}</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;Deploying&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_7-expression" tabindex="-1"><a class="header-anchor" href="#_7-expression" aria-hidden="true">#</a> 7，expression</h4><p><strong><code>expression</code></strong> ：当指定的Groovy表达式求值为true时执行阶段。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	expression <span class="token punctuation">{</span> <span class="token keyword">return</span> params<span class="token punctuation">.</span>DEBUG_BUILD <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意，从表达式返回字符串时，必须将它们转换为布尔值或返回<code>null</code>表示为<code>false</code>。 简单地返回<code>0</code>或<code>false</code>仍将评估为<code>true</code>。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span>
	expression <span class="token punctuation">{</span> BRANCH_NAME <span class="token operator">==~</span> <span class="token string regex">/(production|staging)/</span> <span class="token punctuation">}</span>
	anyOf <span class="token punctuation">{</span>
		environment name<span class="token punctuation">:</span> <span class="token string">&#39;DEPLOY_TO&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">&#39;production&#39;</span>
		environment name<span class="token punctuation">:</span> <span class="token string">&#39;DEPLOY_TO&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">&#39;staging&#39;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_8-changelog" tabindex="-1"><a class="header-anchor" href="#_8-changelog" aria-hidden="true">#</a> 8，changelog</h4><p>如果构建的SCM更新日志包含给定的正则表达式模式，则执行该阶段 例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	changelog <span class="token string">&#39;.*^\\[DEPENDENCY\\] .+<!--vuepress-ssr-app-->#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_9-changeset" tabindex="-1"><a class="header-anchor" href="#_9-changeset" aria-hidden="true">#</a> 9，changeset</h4><p>如果构建的SCM变更集包含与给定字符串或glob匹配的一个或多个文件，则执行该阶段。 例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	changeset <span class="token string gstring">&quot;**/*.js&quot;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>默认情况下，路径匹配不区分大小写，可以使用caseSensitive参数关闭, 例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	changeset glob<span class="token punctuation">:</span> <span class="token string gstring">&quot;ReadMe.*&quot;</span><span class="token punctuation">,</span> caseSensitive<span class="token punctuation">:</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_10-equals" tabindex="-1"><a class="header-anchor" href="#_10-equals" aria-hidden="true">#</a> 10，equals</h4><p>当期望值等于实际值时执行阶段， 例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	equals expected<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> actual<span class="token punctuation">:</span> currentBuild<span class="token punctuation">.</span>number 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_11-tag" tabindex="-1"><a class="header-anchor" href="#_11-tag" aria-hidden="true">#</a> 11，tag</h4><p>如果<code>TAG_NAME</code>变量与给定模式匹配，则执行该阶段。例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	tag <span class="token string gstring">&quot;release-*&quot;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果提供了空模式，则如果<code>TAG_NAME</code>变量存在，则将执行该阶段（与buildingTag（）相同）。</p><p>可以在属性之后添加可选参数比较器，以指定如何评估匹配的任何模式：<code>EQUALS</code>用于简单字符串比较（默认值），<code>GLOB</code>用于ANT样式路径glob（与例如变更集相同）或<code>REGEXP</code>用于常规 表达匹配。 例如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> 
	tag pattern<span class="token punctuation">:</span> <span class="token string gstring">&quot;release-\\d+&quot;</span><span class="token punctuation">,</span> comparator<span class="token punctuation">:</span> <span class="token string gstring">&quot;REGEXP&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_12-triggeredby" tabindex="-1"><a class="header-anchor" href="#_12-triggeredby" aria-hidden="true">#</a> 12，triggeredBy</h4><p>在给定的参数触发当前构建时执行该阶段。例如：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>when <span class="token punctuation">{</span> triggeredBy <span class="token string">&#39;SCMTrigger&#39;</span> <span class="token punctuation">}</span>

when <span class="token punctuation">{</span> triggeredBy <span class="token string">&#39;TimerTrigger&#39;</span> <span class="token punctuation">}</span>

when <span class="token punctuation">{</span> triggeredBy <span class="token string">&#39;UpstreamCause&#39;</span> <span class="token punctuation">}</span>

when <span class="token punctuation">{</span> triggeredBy cause<span class="token punctuation">:</span> <span class="token string gstring">&quot;UserIdCause&quot;</span><span class="token punctuation">,</span> detail<span class="token punctuation">:</span> <span class="token string gstring">&quot;vlinde&quot;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_7-triggers" tabindex="-1"><a class="header-anchor" href="#_7-triggers" aria-hidden="true">#</a> 7，triggers</h3><p><code>triggers</code>指令用于定义流水线触发的一些机制与条件。常规情况下，我们的项目都是基于手动点击部署，这种策略尤其适用于线上环境，但在测试环境，乃至于预发环境，应该对自动构建有更高的集成度，使开发者只关注于开发，而不必过多纠结构建的过程。</p><p>目前流水线支持的触发器有三种：<code>cron</code>, <code>pollSCM</code> 和 <code>upstream</code>。</p><h4 id="_1-cron" tabindex="-1"><a class="header-anchor" href="#_1-cron" aria-hidden="true">#</a> 1，cron</h4><p>采用与Linux系统一样的定时任务管理方案，当然也加入了一些更简单的参数项，以应对某些需要定期执行的场景，其实如果发散一下思维，我们完全可以用cron这种功能，来作为整个系统的定时任务管理中心，所有主机的定时任务都汇总到这里来，管理起来也方便很多。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    triggers <span class="token punctuation">{</span>
        <span class="token function">cron</span><span class="token punctuation">(</span><span class="token string">&#39;* * * * *&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;cronjob test&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;这是一个定期执行的任务&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>定时任务的语法就不展开讲了，只列几个比较特殊的，而且比较有空的。</p><ul><li><p><code>H</code>关键字，H亦即Hash，表示当前位置跨度范围内随机一值。</p><p>假如我们使用定时任务功能，像我上边提到的，管理了大量的机器，那么如果在同一时间突然批量的机器执行任务，势必会产生负载不均衡的情况，这个时候就可以这样写：<code>H 02 * * *</code>表示凌晨两点的一个小时中，随机的一个时间点执行任务。</p></li><li><p>同时还可以用一些别名来简化操作。</p><ul><li><code>@yearly</code>：每年执行一次</li><li><code>@monthly</code>：每月执行一次</li><li><code>@weekly</code>：每周执行一次</li><li><code>@daily</code>：每天执行一次</li><li><code>@midnight</code>：代表半夜12点到凌晨2:59之间的某个时间。</li><li><code>@hourly</code>：每小时执行一次</li></ul></li></ul><h4 id="_2-pollscm" tabindex="-1"><a class="header-anchor" href="#_2-pollscm" aria-hidden="true">#</a> 2，pollSCM</h4><p>表示定期对代码仓库进行检测，如果有变化，则自动触发构建。我思索再三，没有想到这种策略在实际生产中的应用场景，故此不做过多介绍。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    triggers <span class="token punctuation">{</span>
        <span class="token function">pollSCM</span><span class="token punctuation">(</span><span class="token string">&#39;* * * * *&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;cronjob test&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;每分钟检测一次代码仓库的变化&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_3-upstream" tabindex="-1"><a class="header-anchor" href="#_3-upstream" aria-hidden="true">#</a> 3，upstream</h4><p>当B项目的执行依赖A项目的执行结果是，A就是B的上游项目，在Jenkins2.22以上的版本中，可以通过upstream关键字进行这种关系的表示。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>triggers <span class="token punctuation">{</span> 
		<span class="token comment">// job1,job2都是任务名称</span>
		<span class="token function">upstream</span><span class="token punctuation">(</span>upstreamProjects<span class="token punctuation">:</span> <span class="token string">&#39;job1,job2&#39;</span><span class="token punctuation">,</span> threshold<span class="token punctuation">:</span> hudson<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Result<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>hudson.model.Result</code>是一个枚举用于指示上游项目状态，包含以下指令：</p><ul><li>ABORTED：任务被手动终止。</li><li>FAILURE：构建失败。</li><li>SUCCESS：构建成功。</li><li>UNSTABLE：存在一些错误，但不至于构建失败。</li><li>NOT_BUILT：再多阶段构建时，前面阶段的问题导致后面阶段无法执行。</li></ul><h4 id="_4-gitlab事件触发。" tabindex="-1"><a class="header-anchor" href="#_4-gitlab事件触发。" aria-hidden="true">#</a> 4，gitlab事件触发。</h4><p>这个才是真正更多应用场景的，大多时候，我们都默认将项目配置为，开发者提交某些分支，然后自动触发对应的构建。传统方式下，需要比较复杂的几步配置，但是在pipeline中也可以通过代码形式对这种触发器进行配置，实在是一大便利神器。</p><p>到这儿，基本上每个项目在Jenkins当中的耦合，我们可以看到，越来越少了，我们运维人员，只需专注维护 <code>Jenkinsfile</code>，然后创建对应项目，只需在流水线处配置代码url即可。</p><p>这里先简单做一下示例介绍，并不展开，后边也会专门写篇文章来介绍这种应用方式，注意，gitlab触发Jenkins的构建需要依赖<code>Gitlab插件</code>，而并不需要插件当中列出来的所谓的gitlab hook。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    triggers<span class="token punctuation">{</span>
        <span class="token function">gitlab</span><span class="token punctuation">(</span> triggerOnPush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                triggerOnMergeRequest<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                branchFilterType<span class="token punctuation">:</span> <span class="token string">&#39;All&#39;</span><span class="token punctuation">,</span>
                secretToken<span class="token punctuation">:</span> <span class="token string gstring">&quot;028d848ab64f&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;提交触发的构建&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>对于触发器所用到的参数，这里简单介绍一下：</p><ul><li><p>triggerOnPush：当Gitlab触发push事件时，是否执行构建。</p></li><li><p>triggerOnMergeRequest：当Gitlab触发mergeRequest事件时，是否执行构建。</p></li><li><p>branchFilterType：只有符合条件的分支才会触发构建，必选，否则无法实现触发。</p><p>可选参数有：</p><ul><li>All：所有分支。</li><li>NameBasedFilter：基于分支名进行过滤，多个分支名使用逗号分隔。 <ul><li>includeBranchesSpec：基于branchFilterType值，输入期望包括的分支的规则。</li><li>excludeBranchesSpec：基于branchFilterType值，输入期望排除的分支的规则。</li></ul></li><li>RegexBasedFilter：基于正则表达式对分支名进行过滤。 <ul><li>sourceBranchRegex：定义期望的通过正则表达式限制的分支规则。</li></ul></li></ul><p>所有分支这个选项不用解释了，其余两个选项怎么用，才是比较重要，而且可能在实际生产中，经常或者一定会用到的。但是网上的文章，乃至于Jenkins的官方文档，也都只是像上边那样，提到了有这样的语法规则存在，并没有任何一个地方给出示例的，当我去到Gitlab插件的官方地址后，发现了下边第一种语法的简单示例，仍旧没有我想要的基于正则限制的那种，于是，各位注意，看到这个地方的，都是缘分，也是福气，因为搜遍全网也没有的示例，首次亮相，就是在这里。</p><ul><li>如果只接受固定分支的触发请求，语法如下：</li></ul><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>	triggers<span class="token punctuation">{</span>
        <span class="token function">gitlab</span><span class="token punctuation">(</span> triggerOnPush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                triggerOnMergeRequest<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
								branchFilterType<span class="token punctuation">:</span> <span class="token string gstring">&quot;NameBasedFilter&quot;</span><span class="token punctuation">,</span>
                includeBranchesSpec<span class="token punctuation">:</span> <span class="token string gstring">&quot;release&quot;</span><span class="token punctuation">,</span>
                secretToken<span class="token punctuation">:</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>git_token<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>如果想通过正则匹配到某些分支进行触发，语法如下：</li></ul><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>	triggers<span class="token punctuation">{</span>
        <span class="token function">gitlab</span><span class="token punctuation">(</span> triggerOnPush<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                triggerOnMergeRequest<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
								branchFilterType<span class="token punctuation">:</span> <span class="token string gstring">&quot;RegexBasedFilter&quot;</span><span class="token punctuation">,</span>
                sourceBranchRegex<span class="token punctuation">:</span> <span class="token string gstring">&quot;test.*&quot;</span><span class="token punctuation">,</span>
                secretToken<span class="token punctuation">:</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>git_token<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul><p><code>注意：</code>所有触发器同样都需要先手动执行一次，让Jenkins加载其中的配置，对应的指令才会生效。</p><h3 id="_8-parallel" tabindex="-1"><a class="header-anchor" href="#_8-parallel" aria-hidden="true">#</a> 8，parallel</h3><p>parallel关键字用于指定某些阶段可以并行的情况，当然，流水线的情况下，大概率都是串行的场景，也正符合所谓流水管道的定义，这里简单介绍一下并行的用法，并不展开过多讲解。</p><p>声明式流水线的阶段可以在他们内部声明多隔嵌套阶段, 它们将并行执行。 注意，一个阶段必须只有一个 <code>steps</code> 或 <code>parallel</code> 的阶段。 嵌套阶段本身不能包含进一步的 <code>parallel</code> 阶段, 但是其他的阶段的行为与任何其他 <code>stage</code> 相同。任何包含 <code>parallel</code> 的阶段不能包含 <code>agent</code> 或 <code>tools</code> 阶段, 因为他们没有相关 <code>steps</code>。</p><p>另外, 通过添加 <code>failFast true</code> 到包含 <code>parallel</code>的 <code>stage</code> 中， 当其中一个进程失败时，你可以强制所有的 <code>parallel</code> 阶段都被终止。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any	
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Non-Parallel Stage&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;This stage will be executed first.&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Parallel Stage&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            failFast <span class="token boolean">true</span>
            parallel <span class="token punctuation">{</span>
                <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;并行一&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    steps <span class="token punctuation">{</span>
                        echo <span class="token string gstring">&quot;并行一&quot;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;并行二&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    steps <span class="token punctuation">{</span>
                        echo <span class="token string gstring">&quot;并行二&quot;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;并行三&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    stages <span class="token punctuation">{</span>
                        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Nested 1&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            steps <span class="token punctuation">{</span>
                                echo <span class="token string gstring">&quot;In stage Nested 1 within Branch C&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Nested 2&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            steps <span class="token punctuation">{</span>
                                echo <span class="token string gstring">&quot;In stage Nested 2 within Branch C&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="_3-其他参数" tabindex="-1"><a class="header-anchor" href="#_3-其他参数" aria-hidden="true">#</a> 3，其他参数</h2><h3 id="_1-sh" tabindex="-1"><a class="header-anchor" href="#_1-sh" aria-hidden="true">#</a> 1，sh</h3><p>当我们需要执行系统命令的时候，可以通过此关键字引入。简单示例如下：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;部署到测试环境&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    when <span class="token punctuation">{</span>
        branch <span class="token string">&#39;test&#39;</span>
    <span class="token punctuation">}</span>
    steps<span class="token punctuation">{</span>
        sh <span class="token string">&#39;rsync -avz --progress -e &#39;</span>ssh <span class="token operator">-</span>p <span class="token number">22</span><span class="token string">&#39; --exclude=&#39;</span>Jenkinsfile<span class="token string">&#39; --exclude=&#39;</span><span class="token punctuation">.</span>git<span class="token string">&#39; --delete ${WORKSPACE}/  root@$remote_ip:$remote_dir&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;部署到线上环境&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    when <span class="token punctuation">{</span>
        branch <span class="token string">&#39;master&#39;</span>
    <span class="token punctuation">}</span>
    steps <span class="token punctuation">{</span>
        sh <span class="token string">&#39;&#39;&#39;
            echo &quot;开始部署&quot;
            rsync -avz --progress -e &#39;ssh -p 22&#39; --exclude=&#39;Jenkinsfile&#39; --exclude=&#39;.git&#39; --delete ${WORKSPACE}/  root@192.168.3.61:$remote_dir
        &#39;&#39;&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_2-deletedir" tabindex="-1"><a class="header-anchor" href="#_2-deletedir" aria-hidden="true">#</a> 2，deleteDir</h3><p>表示删除当前目录，通常用在构建完毕之后清空工作空间，或者结合dir关键字使用。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    steps <span class="token punctuation">{</span>
        echo <span class="token string">&#39;清理工作目录&#39;</span>
        <span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>另外还有一个clean（此方法依赖于插件 <code>Workspace Cleanup</code>）清理工作空间时用法与之类似。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    steps <span class="token punctuation">{</span>
        echo <span class="token string">&#39;清理工作目录&#39;</span>
        <span class="token function">cleanWs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>区别在于deleteDir可以指定目录删除。</p><h3 id="_3-dir。" tabindex="-1"><a class="header-anchor" href="#_3-dir。" aria-hidden="true">#</a> 3，dir。</h3><p>切换目录，默认流水线工作中工作空间目录中，使用dir可以进行目录的切换。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">dir</span><span class="token punctuation">(</span><span class="token string gstring">&quot;/var/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">deleteDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_4-fileexists" tabindex="-1"><a class="header-anchor" href="#_4-fileexists" aria-hidden="true">#</a> 4，fileExists</h3><p>判断文件是否存在。可用绝对路径，也可以使用相对路径，相对路径的时候，记住是基于 <code>$WORKSPACE</code>的。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
    agent any
    environment <span class="token punctuation">{</span>
        git_url     <span class="token operator">=</span> <span class="token string gstring">&quot;git@192.168.3.65:jenkins-learn/hello-world.git&quot;</span>
        remote_ip   <span class="token operator">=</span> <span class="token string gstring">&quot;192.168.3.67&quot;</span>
        remote_dir  <span class="token operator">=</span> <span class="token string gstring">&quot;/opt/hello&quot;</span>
    <span class="token punctuation">}</span>
    options <span class="token punctuation">{</span>
        <span class="token function">buildDiscarder</span><span class="token punctuation">(</span><span class="token function">logRotator</span><span class="token punctuation">(</span>numToKeepStr<span class="token punctuation">:</span> <span class="token string">&#39;10&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">disableConcurrentBuilds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    stages <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;rsync&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                script <span class="token punctuation">{</span>
                    build_file <span class="token operator">=</span> <span class="token string gstring">&quot;<span class="token expression"><span class="token punctuation">$</span>WORKSPACE</span>/README.md&quot;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fileExists</span><span class="token punctuation">(</span>build_file<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sh <span class="token string">&#39;&#39;&#39;
                        rsync -avz --progress -e &#39;ssh -p 22&#39; --exclude=&#39;Jenkinsfile&#39; --exclude=&#39;.git&#39; --delete ${WORKSPACE}/  root@$remote_ip:$remote_dir
                    &#39;&#39;&#39;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string gstring">&quot;here haven&#39;t find json file&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;delete&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                echo <span class="token string">&#39;清理工作目录&#39;</span>
                <span class="token function">cleanWs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    post <span class="token punctuation">{</span>
        success <span class="token punctuation">{</span>
            sh <span class="token string gstring">&quot;echo 成功了&quot;</span>
        <span class="token punctuation">}</span>
        failure <span class="token punctuation">{</span>
            sh <span class="token string gstring">&quot;echo 失败了&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>这个例子比较适合生产当中的情境，部署的步骤放在编译的后边，如果编译之后，Java项目的war包没有生成，那么我们跳出构建，如果生成了，则执行构建的步骤。</p><h3 id="_5-error" tabindex="-1"><a class="header-anchor" href="#_5-error" aria-hidden="true">#</a> 5，error</h3><p>主动报错，终止当前流水线。</p><p>上边已经引用到了，通常在布尔参数之后会选用。</p><h3 id="_6-timeout" tabindex="-1"><a class="header-anchor" href="#_6-timeout" aria-hidden="true">#</a> 6，timeout</h3><p>代码块超时时间。通常这在执行一些编译步骤如遇不可知情况导致编译失败而又不退出的情况。</p><p>timeout支持如下参数：</p><ul><li>time：整型，超时时间。</li><li>unit：时间单位，支持的值有NANOSECONDS,MICROSECONDS,MILLISECONDS,SECONDS,MINUTES(默认),HOURS,DAYS.</li><li>activity：布尔类型，如果为true，则只有当日志没有活动之后，才真正算超时。</li></ul><p>用法，直接在将要执行的阶段之外，用关键字包裹即可：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		steps<span class="token punctuation">{</span>
        sh <span class="token string">&#39;rsync -avz --progress -e &#39;</span>ssh <span class="token operator">-</span>p <span class="token number">22</span><span class="token string">&#39; --exclude=&#39;</span>Jenkinsfile<span class="token string">&#39; --exclude=&#39;</span><span class="token punctuation">.</span>git<span class="token string">&#39; --delete ${WORKSPACE}/  root@$remote_ip:$remote_dir&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_7-waitutil" tabindex="-1"><a class="header-anchor" href="#_7-waitutil" aria-hidden="true">#</a> 7，waitUtil</h3><p>等待条件满足，不断重复代码块中的内容，直到条件为true。这个功能的应用场景我倒是想到了一个，很贴切，有一些服务在生产环境跑着，并不能直接关闭发布，而往往加入一个优雅停机的功能，因此调用停机接口之后，我们就可以做一个等待，等待服务端口彻底关闭之后，再进行部署，当然，最好再配合一下timeout，以避免死循环。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    waitUntil<span class="token punctuation">{</span>
        script<span class="token punctuation">{</span>
            <span class="token keyword">def</span> r <span class="token operator">=</span> sh script<span class="token punctuation">:</span> <span class="token string">&#39;curl http://exmaple&#39;</span><span class="token punctuation">,</span>returnStatus<span class="token punctuation">:</span> <span class="token boolean">true</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span> r <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_8-retry" tabindex="-1"><a class="header-anchor" href="#_8-retry" aria-hidden="true">#</a> 8，retry</h3><p>重复执行某个块，如果某次执行中有异常，则跳出当次，而不会影响整体。注意，在执行retry过程中，用户无法手动终止流水线。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>steps <span class="token punctuation">{</span>
  <span class="token function">retry</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    script<span class="token punctuation">{</span>
        sh script<span class="token punctuation">:</span> <span class="token string">&#39;curl http://exmaple&#39;</span><span class="token punctuation">,</span>returnStatus<span class="token punctuation">:</span> <span class="token boolean">true</span>        
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>注意：</code>使用retry将执行的内容包住。</p><h3 id="_9-sleep" tabindex="-1"><a class="header-anchor" href="#_9-sleep" aria-hidden="true">#</a> 9，sleep</h3><p>让pipeline睡眠一段时间。</p><p>支持参数如下：</p><ul><li>time：整型，休眠时间。</li><li>unit：时间单位，支持的值有NANOSECONDS,MICROSECONDS,MILLISECONDS,SECONDS(默认),MINUTES,HOURS,DAYS.</li></ul><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span> <span class="token comment">//休眠120秒</span>
<span class="token function">sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token string">&#39;2&#39;</span><span class="token punctuation">,</span>unit<span class="token punctuation">:</span> <span class="token string gstring">&quot;MINUTES&quot;</span><span class="token punctuation">)</span> <span class="token comment">//休眠2分钟</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_10-try-catch" tabindex="-1"><a class="header-anchor" href="#_10-try-catch" aria-hidden="true">#</a> 10，try&amp;catch</h3><p>尽管我非常推崇日常构建采用声明式的即可，但是有一些脚本式中比较不错的参数，也是值得学习，而且值得运用的。这个try与catch就是类似的一种。</p><p>日常流水线构建中，我们希望整条线每一阶段都是正常的，一旦有异常的情况，就应该退出构建。比如我们不应该在编译代码失败的情况下，还去重启服务，部署服务，这样极可能会造成一些不可知的问题，严重的还可能因为构建引发服务问题。</p><p>简单说明就是，流水线会顺行执行try关键字块内的语句，如果所有语句执行都正常，那么程序正常退出，如果有异常，则catch部分将会捕捉错误，进行打印，并退出整个流水线，这一点非常关键，某个阶段有异常，整个构建结束，这一特性，值得推广到所有的流水线当中应用起来。</p><p>简单示例：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline<span class="token punctuation">{</span>
    agent any
    stages<span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Example1&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                script <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        echo <span class="token string">&#39;aaa&#39;</span>
                        eccho <span class="token string">&#39;bbb&#39;</span>
                        echo <span class="token string">&#39;ccc&#39;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        echo <span class="token string">&#39;err&#39;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>       
        <span class="token punctuation">}</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Example2&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            steps <span class="token punctuation">{</span>
                script <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        echo <span class="token string">&#39;aaa&#39;</span>
                        echo <span class="token string">&#39;ccc&#39;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        echo <span class="token string">&#39;err&#39;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>       
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    post<span class="token punctuation">{</span>
        always<span class="token punctuation">{</span>
            echo <span class="token string gstring">&quot;========always========&quot;</span>
        <span class="token punctuation">}</span>
        success<span class="token punctuation">{</span>
            echo <span class="token string gstring">&quot;========pipeline executed successfully ========&quot;</span>
        <span class="token punctuation">}</span>
        failure<span class="token punctuation">{</span>
            echo <span class="token string gstring">&quot;========pipeline execution failed========&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>将代码放到pipeline当中，执行以下，可以看下构建日志：</p><p><img src="http://t.eryajf.net/imgs/2021/09/5622caefe254f02c.jpg" alt="img"></p><p>可以看到，因为阶段1中有异常，导致程序退出，阶段2也没有执行，并且在最后抛出了异常的内容。</p><h3 id="_11-docker" tabindex="-1"><a class="header-anchor" href="#_11-docker" aria-hidden="true">#</a> 11，docker</h3><p>在流水线中使用docker，能够方便我们对一些环境进行隔离，以及一些优秀语法的应用使得构建更加优雅。</p><p>上边agent调用docker已经介绍了，这里着重再说明一下打镜像的操作。</p><h4 id="_1-构建容器" tabindex="-1"><a class="header-anchor" href="#_1-构建容器" aria-hidden="true">#</a> 1，构建容器</h4><p>为了构建 Docker 镜像,<a href="https://plugins.jenkins.io/docker-workflow" target="_blank" rel="noopener noreferrer">Docker 流水线<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 插件也提供了一个 <code>build()</code> 方法用于在流水线运行期间从存储库的<code>Dockerfile</code> 中创建一个新的镜像。</p><p>使用语法 <code>docker.build(&quot;my-image-name&quot;)</code> 的主要好处是， 脚本化的流水线能够使用后续 Docker流水线调用的返回值, 比如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string gstring">&quot;my-image:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>BUILD_ID<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    customImage<span class="token punctuation">.</span>inside <span class="token punctuation">{</span>
        sh <span class="token string">&#39;make test&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>该返回值也可以用于通过 <code>push()</code> 方法将Docker 镜像发布到 <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, 或 <a href="https://www.jenkins.io/zh/doc/book/pipeline/docker/#custom-registry" target="_blank" rel="noopener noreferrer">custom Registry<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>,比如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string gstring">&quot;my-image:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>BUILD_ID<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    customImage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>镜像 &quot;tags&quot;的一个常见用法是 为最近的, 验证过的, Docker镜像的版本，指定 <code>latest</code> 标签。 <code>push()</code> 方法接受可选的 <code>tag</code> 参数, 允许流水线使用不同的标签 push <code>customImage</code> , 比如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string gstring">&quot;my-image:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>BUILD_ID<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    customImage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    customImage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;latest&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在默认情况下， <code>build()</code> 方法在当前目录构建一个 <code>Dockerfile</code>。提供一个包含 <code>Dockerfile</code>文件的目录路径作为<code>build()</code> 方法的第二个参数 就可以覆盖该方法, 比如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    <span class="token keyword">def</span> testImage <span class="token operator">=</span> docker<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string gstring">&quot;test-image&quot;</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;./dockerfiles/test&quot;</span><span class="token punctuation">)</span> 

    testImage<span class="token punctuation">.</span>inside <span class="token punctuation">{</span>
        sh <span class="token string">&#39;make test&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>从在 <code>./dockerfiles/test/Dockerfile</code>中发现的Dockerfile中构建<code>test-image</code>。</p><p>通过添加其他参数到 <code>build()</code> 方法的第二个参数中，传递它们到 <a href="https://docs.docker.com/engine/reference/commandline/build/" target="_blank" rel="noopener noreferrer">docker build<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>。 当使用这种方法传递参数时, 该字符串的最后一个值必须是Docker文件的路径。</p><p>该示例通过传递 <code>-f</code>标志覆盖了默认的 <code>Dockerfile</code> :</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    <span class="token keyword">def</span> dockerfile <span class="token operator">=</span> <span class="token string">&#39;Dockerfile.test&#39;</span>
    <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string gstring">&quot;my-image:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>BUILD_ID<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;-f <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerfile<span class="token punctuation">}</span></span> ./dockerfiles&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>从在<code>./dockerfiles/Dockerfile.test</code>发现的Dockerfile构建 <code>my-image:${env.BUILD_ID}</code>。</p><h4 id="_2-使用自定义注册表" tabindex="-1"><a class="header-anchor" href="#_2-使用自定义注册表" aria-hidden="true">#</a> 2，使用自定义注册表</h4><p>默认情况下， <a href="https://plugins.jenkins.io/docker-workflow" target="_blank" rel="noopener noreferrer">Docker 流水线<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 集成了 <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>默认的 Docker注册表。 .</p><p>为了使用自定义Docker 注册吧, 脚本化流水线的用户能够使用 <code>withRegistry()</code> 方法完成步骤，传入自定义注册表的URL, 比如:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm

    docker<span class="token punctuation">.</span><span class="token function">withRegistry</span><span class="token punctuation">(</span><span class="token string">&#39;https://registry.example.com&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        docker<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">&#39;my-custom-image&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inside <span class="token punctuation">{</span>
            sh <span class="token string">&#39;make test&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对于需要身份验证的Docker 注册表, 从Jenkins 主页添加一个 &quot;Username/Password&quot; 证书项， 并使用证书ID 作为 <code>withRegistry()</code>的第二个参数:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm

    docker<span class="token punctuation">.</span><span class="token function">withRegistry</span><span class="token punctuation">(</span><span class="token string">&#39;https://registry.example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;credentials-id&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string gstring">&quot;my-image:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>env<span class="token punctuation">.</span>BUILD_ID<span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>

        <span class="token comment">/* Push the container to the custom Registry */</span>
        customImage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_3-运行-sidecar-容器" tabindex="-1"><a class="header-anchor" href="#_3-运行-sidecar-容器" aria-hidden="true">#</a> 3，运行 &quot;sidecar&quot; 容器</h4><p>在流水线中使用Docker可能是运行构建或一组测试的所依赖的服务的有效方法。类似于 <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar" target="_blank" rel="noopener noreferrer">sidecar 模式<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, Docker 流水线可以&quot;在后台&quot;运行一个容器 , 而在另外一个容器中工作。 利用这种sidecar 方式, 流水线可以为每个流水线运行 提供一个&quot;干净的&quot; 容器。</p><p>考虑一个假设的集成测试套件，它依赖于本地 MySQL 数据库来运行。使用 <code>withRun</code> 方法, 在 <a href="https://plugins.jenkins.io/docker-workflow" target="_blank" rel="noopener noreferrer">Docker Pipeline<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 插件中实现对脚本化流水线的支持, <code>Jenkinsfile</code> 文件可以运行 MySQL作为sidecar :</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    <span class="token comment">/*
     * In order to communicate with the MySQL server, this Pipeline explicitly
     * maps the port (`3306`) to a known port on the host machine.
     */</span>
    docker<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">&#39;mysql:5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withRun</span><span class="token punctuation">(</span><span class="token string">&#39;-e &quot;MYSQL_ROOT_PASSWORD=my-secret-pw&quot; -p 3306:3306&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c <span class="token operator">-&gt;</span>
        <span class="token comment">/* Wait until mysql service is up */</span>
        sh <span class="token string">&#39;while ! mysqladmin ping -h0.0.0.0 --silent; do sleep 1; done&#39;</span>
        <span class="token comment">/* Run some tests which require MySQL */</span>
        sh <span class="token string">&#39;make check&#39;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>该示例可以更进一步, 同时使用两个容器。 一个 &quot;sidecar&quot; 运行 MySQL, 另一个提供<a href="https://www.jenkins.io/zh/doc/book/pipeline/docker/#execution-environment" target="_blank" rel="noopener noreferrer">执行环境<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, 通过使用Docker <a href="https://docs.docker.com/engine/userguide/networking/default_network/dockerlinks/" target="_blank" rel="noopener noreferrer">容器链接<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>。</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    checkout scm
    docker<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">&#39;mysql:5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withRun</span><span class="token punctuation">(</span><span class="token string">&#39;-e &quot;MYSQL_ROOT_PASSWORD=my-secret-pw&quot;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> c <span class="token operator">-&gt;</span>
        docker<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">&#39;mysql:5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inside</span><span class="token punctuation">(</span><span class="token string gstring">&quot;--link <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>:db&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Wait until mysql service is up */</span>
            sh <span class="token string">&#39;while ! mysqladmin ping -hdb --silent; do sleep 1; done&#39;</span>
        <span class="token punctuation">}</span>
        docker<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">&#39;centos:7&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inside</span><span class="token punctuation">(</span><span class="token string gstring">&quot;--link <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>:db&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * Run some tests which require MySQL, and assume that it is
             * available on the host name `db`
             */</span>
            sh <span class="token string">&#39;make check&#39;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上面的示例使用 <code>withRun</code>公开的项目, 它通过 <code>id</code> 属性具有可用的运行容器的ID。使用该容器的 ID, 流水线通过自定义 Docker 参数生成一个到<code>inside()</code> 方法的链。</p><p>The <code>id</code> property can also be useful for inspecting logs from a running Docker container before the Pipeline exits:</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>sh <span class="token string gstring">&quot;docker logs <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="_12-withenv" tabindex="-1"><a class="header-anchor" href="#_12-withenv" aria-hidden="true">#</a> 12，withEnv</h3><p>默认情况下声明的环境变量的生效时间都是贯穿整个流水线声明的，如果想要更改一个变量的值，则可以用 <code>withEnv</code>临时修改，在区块之外即恢复：</p><div class="language-groovy ext-groovy line-numbers-mode"><pre class="language-groovy"><code>pipeline <span class="token punctuation">{</span>
   agent any
   environment <span class="token punctuation">{</span>
       Name <span class="token operator">=</span> <span class="token string">&#39;null&#39;</span>
   <span class="token punctuation">}</span>

   stages   <span class="token punctuation">{</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Stage 1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        steps<span class="token punctuation">{</span>
            <span class="token function">catchError</span><span class="token punctuation">(</span>buildResult<span class="token punctuation">:</span> <span class="token string">&#39;UNSTABLE&#39;</span><span class="token punctuation">,</span> stageResult<span class="token punctuation">:</span> <span class="token string">&#39;FAILURE&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               script <span class="token punctuation">{</span>
                    echo env<span class="token punctuation">.</span>Test_Category_Name <span class="token comment">// 输出 null</span>
                    <span class="token function">withEnv</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string gstring">&quot;Name =Test&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       echo env<span class="token punctuation">.</span>Test_Category_Name <span class="token comment">// 输出 Test</span>
                    <span class="token punctuation">}</span>
                    echo env<span class="token punctuation">.</span>Test_Category_Name <span class="token comment">// 输出 null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>参考内容：</p><ul><li><a href="https://jenkins.io/zh/doc/book/pipeline/syntax/" target="_blank" rel="noopener noreferrer">Jenkins官方文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li>https://blog.csdn.net/u011541946</li><li>Jenkins 2.x实践指南</li></ul><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/eryajf/eryajf.github.io/edit/main/02.系列专题/05.Jenkins系列文章/32.Jenkinsfile声明式语法详解.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: fengxuechao@tal.com">fengxuechao</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="./assets/app.dbf5d933.js" defer></script>
  </body>
</html>

---
title: 学习周刊-2021年第52周
date: 2022-01-03 18:13:12
permalink: /code/pages/220103181312.html
categories:
  - 编程世界
  - Go编程笔记 
tags: 
  - golang
  - GC垃圾回收
---

##0. 前言

::: tip

1. 标记-清除算法(mark and sweep)
2. 三色标记法
3. 强-弱三色不变式、插入屏障、删除屏障
4. 混合写屏障机制

:::

##1. 标记-清除算法整体过程

- 暂停程序业务逻辑，分出可达和不可达的对象，然后做上标记
- 标记完成后，然后开始清除未标记的对象

短处：make and sweep算法在执行的时候，需要程序暂停，即STW(stop the world)，因此STW过程中，造成了CPU的浪费。

##2. 三色标记

- 每次创建新的对象，默认的颜色都标记为白色
- 每次GC回收开始，会从根节点开始遍历所有对象(我们的程序可抵达的内存对象)，把遍历到的对象从白色集合放入灰色集合中，只遍历一次，非递归形式
- 遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入到黑色集合
- 重复第三步，直到灰色中无任何对象，当全部可达对象遍历完后，删除白色(程序不可达)的对象

短处：为了防止当一个白色对象被黑色对象引用(白色被挂在了黑色下)或灰色对象与它之间的可达关系的白色对象遭到破坏(灰色同时丢了该白色)对象丢失现象，还是需要STW，GC效率低下

##3. 强-弱三色不变式、插入写屏障、删除写屏障

- 强三色不变式强调不存在黑色对象引用到白色对象的指针，从而不会出现白色对象被误删的情况
- 弱三色不变式强调黑色对象可以引用白色对象，但是这个白色对象必须存在其他灰色对象对它的引用，或者可达它的链路上游存在灰色对象

为了遵循上述两种方式，GC算法演进出两种屏障方式：插入屏障和删除屏障

- 插入屏障的具体操作是，在A对象引用B对象的时候，B对象被标记会灰色；栈空间容量小，但速度要求快，函数调用弹出频繁使用，所以插入屏障机制仅仅使用在堆空间对象的操作中。那么栈空间仍然需要二次STW
- 删除屏障的具体操作是，被删除的对象如果自身为灰色或者白色，那么被标记为灰色。标记为灰色的目的是为了让被删除的白色对象如果又被其他的黑色对象引用，被删除对象没有变成白色而回收掉。但这种方式的回收精度较低，因为一个对象即使被删除了，但最后一个指向它的指针也依旧可以多活一轮，只有等到下一轮GC才会被清理掉。

##4. 混合写屏障

- GC开始将栈上的对象全部扫描并标记为黑色(之后不再进行第二次重复扫描，无需STW)
- GC期间，任何在栈上创建的新对象，均为黑色
- 被删除的对象标记为灰色
- 被添加的对象标记为灰色

注意;屏障技术是不在栈上应用的，因为要保证栈的运行效率，常见的四种场景：堆删除引用，成为栈下游、栈删除引用，成为栈下游、堆删除引用，成为堆下游、栈删除引用，成为堆下游。


##5. 总结

垃圾回收目前是三色标记加上屏障机制，影响垃圾回收性能的是STW机制，为了保护内存的安全，不得不有STW，但是混合写屏障机制几乎可以完全不用STW来进行并行的垃圾回收，程序并不需要暂定就可以动态的清洗程序中的内存。

GOv1.3普通标记清除法，整体过程需要启动STW，效率极低，
Gov1.5的三色标记加插入写屏障或删除写屏障方法，堆空间启动写屏障，栈空间不启动，全部扫描之后，需要再重新扫描一次栈(需要STW)，效率一般。
Gov1.8三色标记法加混合写屏障机制，栈空间不启动屏障机制，堆空间启动屏障机制。整个过程几乎不需要STW，效率较高


<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.29">
    <link rel="icon" href="/img/memo-favicon.ico"><title>Nginx+consul实现集群主机优雅扩缩容 | Memo</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="modulepreload" href="./assets/app.dbf5d933.js"><link rel="modulepreload" href="./assets/index.html.62e50ffd.js"><link rel="modulepreload" href="./assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="./assets/index.html.4422b278.js">
    <link rel="stylesheet" href="./assets/style.9ca9d938.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a aria-current="page" href="/./ops/pages/d1ef5c/" class="router-link-active router-link-exact-active"><!----><span class="site-name can-hide">Memo</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/./" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./topic/pages/2351.html" class="nav-link" aria-label="ELK"><!--[--><!--]--> ELK <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/1742.html" class="nav-link" aria-label="K8S"><!--[--><!--]--> K8S <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/45c5da/" class="nav-link" aria-label="Nexus"><!--[--><!--]--> Nexus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/2415.html" class="nav-link" aria-label="Jenkins"><!--[--><!--]--> Jenkins <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/220101204130/" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/22020104155458/" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./weekly/pages/11c668/" class="nav-link" aria-label="2021"><!--[--><!--]--> 2021 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./weekly/pages/220103181312/" class="nav-link" aria-label="2022"><!--[--><!--]--> 2022 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./code/pages/aeab08/" class="nav-link" aria-label="Golang"><!--[--><!--]--> Golang <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/5164.html" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/531.html" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./ops/pages/027a17/" class="nav-link" aria-label="最佳实践"><!--[--><!--]--> 最佳实践 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/29.html" class="nav-link" aria-label="迎刃而解"><!--[--><!--]--> 迎刃而解 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/930.html" class="nav-link" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2782.html" class="nav-link" aria-label="Php"><!--[--><!--]--> Php <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/596.html" class="nav-link" aria-label="Zabbix"><!--[--><!--]--> Zabbix <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2468.html" class="nav-link" aria-label="Prometheus"><!--[--><!--]--> Prometheus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5380.html" class="nav-link" aria-label="Grafana"><!--[--><!--]--> Grafana <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5279.html" class="nav-link" aria-label="CentOS"><!--[--><!--]--> CentOS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/1847.html" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5173.html" class="nav-link" aria-label="Ansible"><!--[--><!--]--> Ansible <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/3410.html" class="nav-link" aria-label="Ldap"><!--[--><!--]--> Ldap <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202208241125/" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2951.html" class="nav-link" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202209081510" class="nav-link" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/4050.html" class="nav-link" aria-label="Etcd"><!--[--><!--]--> Etcd <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/285.html" class="nav-link" aria-label="Other"><!--[--><!--]--> Other <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./blog/pages/211229105530.html" class="nav-link" aria-label="博客相关"><!--[--><!--]--> 博客相关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/eryajf/eryajf.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/./" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="专题"><span class="title">专题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./topic/pages/2351.html" class="nav-link" aria-label="ELK"><!--[--><!--]--> ELK <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/1742.html" class="nav-link" aria-label="K8S"><!--[--><!--]--> K8S <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/45c5da/" class="nav-link" aria-label="Nexus"><!--[--><!--]--> Nexus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/2415.html" class="nav-link" aria-label="Jenkins"><!--[--><!--]--> Jenkins <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/220101204130/" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./topic/pages/22020104155458/" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="周刊"><span class="title">周刊</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./weekly/pages/11c668/" class="nav-link" aria-label="2021"><!--[--><!--]--> 2021 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./weekly/pages/220103181312/" class="nav-link" aria-label="2022"><!--[--><!--]--> 2022 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="编程"><span class="title">编程</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./code/pages/aeab08/" class="nav-link" aria-label="Golang"><!--[--><!--]--> Golang <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/5164.html" class="nav-link" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./code/pages/531.html" class="nav-link" aria-label="Shell"><!--[--><!--]--> Shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="运维"><span class="title">运维</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./ops/pages/027a17/" class="nav-link" aria-label="最佳实践"><!--[--><!--]--> 最佳实践 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/29.html" class="nav-link" aria-label="迎刃而解"><!--[--><!--]--> 迎刃而解 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/930.html" class="nav-link" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2782.html" class="nav-link" aria-label="Php"><!--[--><!--]--> Php <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/596.html" class="nav-link" aria-label="Zabbix"><!--[--><!--]--> Zabbix <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2468.html" class="nav-link" aria-label="Prometheus"><!--[--><!--]--> Prometheus <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5380.html" class="nav-link" aria-label="Grafana"><!--[--><!--]--> Grafana <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5279.html" class="nav-link" aria-label="CentOS"><!--[--><!--]--> CentOS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/1847.html" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/5173.html" class="nav-link" aria-label="Ansible"><!--[--><!--]--> Ansible <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/3410.html" class="nav-link" aria-label="Ldap"><!--[--><!--]--> Ldap <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202208241125/" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/2951.html" class="nav-link" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/202209081510" class="nav-link" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/4050.html" class="nav-link" aria-label="Etcd"><!--[--><!--]--> Etcd <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/./ops/pages/285.html" class="nav-link" aria-label="Other"><!--[--><!--]--> Other <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="博客"><span class="title">博客</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/./blog/pages/211229105530.html" class="nav-link" aria-label="博客相关"><!--[--><!--]--> 博客相关 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/eryajf/eryajf.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">最佳实践</p><ul class=""><li><!--[--><a href="/./ops/pages/211225215940/" class="nav-link sidebar-item" aria-label="常见问题及处理方案"><!--[--><!--]--> 常见问题及处理方案 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/./ops/pages/202208241125/" class="nav-link sidebar-item" aria-label="Git代码提交时，报PermissionDenied解决方案"><!--[--><!--]--> Git代码提交时，报PermissionDenied解决方案 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/./ops/pages/1497.html" class="nav-link sidebar-item" aria-label="MySQL数据库增量备份的操作"><!--[--><!--]--> MySQL数据库增量备份的操作 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/./ops/pages/5295.html" class="nav-link sidebar-item" aria-label="MySQL中order by的学习使用"><!--[--><!--]--> MySQL中order by的学习使用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/./ops/pages/202209081510" class="nav-link sidebar-item" aria-label="MySQL批量修改时间的命令"><!--[--><!--]--> MySQL批量修改时间的命令 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">迎刃而解</p><ul class=""><li><!--[--><a href="/./ops/pages/29.html" class="nav-link sidebar-item" aria-label="记一次关于tomcat的踩坑的经历"><!--[--><!--]--> 记一次关于tomcat的踩坑的经历 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="_1-前置准备" tabindex="-1"><a class="header-anchor" href="#_1-前置准备" aria-hidden="true">#</a> 1，前置准备</h2><h3 id="_1-方案选型" tabindex="-1"><a class="header-anchor" href="#_1-方案选型" aria-hidden="true">#</a> 1，方案选型</h3><p>这里选用的方案是：Nginx结合upsync模块儿，结合consul配置管理，实现后端upstream的动态管理。</p><ul><li>选用upsync有如下特性： <ul><li>优点： <ul><li>可以动态对接etcd/consul获取upstream,无需重启nginx</li><li>可以dump内存中的upstream配置到磁盘，即使etcd/consul挂掉仍可正常运行</li></ul></li><li>缺点： <ul><li>无api接口，只能操作etcd/consul来控制upstream</li></ul></li></ul></li></ul><p>模块儿添加，可直接使用<a href="https://github.com/eryajf" target="_blank" rel="noopener noreferrer">二丫<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>下边定制好的spec文件打出rpm包，便于安装使用：</p><p>::: cardList 1</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpmbuild
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> 工作中常用的RPM构建spec
  <span class="token key atrule">avatar</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//avatars2.githubusercontent.com/u/416130<span class="token punctuation">?</span>s=460<span class="token important">&amp;u=8753e86600e300a9811cdc539aa158deec2e2724&amp;v=4</span> <span class="token comment"># 可选</span>
  <span class="token key atrule">link</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/eryajf/rpmbuild <span class="token comment"># 可选</span>
  <span class="token key atrule">bgColor</span><span class="token punctuation">:</span> <span class="token string">&#39;#FBDE4B&#39;</span> <span class="token comment"># 可选，默认var(--bodyBg)。颜色值有#号时请添加单引号</span>
  <span class="token key atrule">textColor</span><span class="token punctuation">:</span> <span class="token string">&#39;#fff&#39;</span> <span class="token comment"># 可选，默认var(--textColor)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>:::</p><h3 id="_2-规范约定" tabindex="-1"><a class="header-anchor" href="#_2-规范约定" aria-hidden="true">#</a> 2，规范约定</h3><ul><li><p>不同业务通过不通的 Cousul Key 来区分拉取配置</p><p>基本规则为: <code>{Env}/nginx/upstreams/{Service}-upsync/{Backend}</code></p><ul><li><code>Env</code>：用于区分环境。测试(test)，预发(pre)，线上(prod)。</li><li><code>Service</code>：指定业务名字，一般与CMDB业务名字一致。</li><li><code>Backend</code>：不同后端的地址信息。</li></ul></li><li><p>约定 Nginx upstream 命名和应用所在CDMB的集群名保持强一致性，全局唯一性</p><p>命名规范: 小写字母和中横线组合，以小写字母开头和结尾，不允许又其他特殊字符，例如下划线等；针对业务集群过渡期间，为了区分接入了自动扩缩容和非自动扩缩容，统一约定在当前 {Service} 后面加上 -upsync 以示区分，例如：user-api，在进行 upsync 自动扩缩容改造后，其命名为 user-api-upsync。</p></li><li><p>约定 upsync_dump_path 的目录与上边目录保持一致，以便于对齐两者，简化运维工作。</p></li></ul><h2 id="_2-nginx配置接入" tabindex="-1"><a class="header-anchor" href="#_2-nginx配置接入" aria-hidden="true">#</a> 2，Nginx配置接入</h2><h3 id="_1-前置准备-1" tabindex="-1"><a class="header-anchor" href="#_1-前置准备-1" aria-hidden="true">#</a> 1，前置准备</h3><p>为了便于验证一个入口多个后端的场景，<a href="https://github.com/eryajf" target="_blank" rel="noopener noreferrer">二丫<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>先通过Nginx准备三个后端服务，一顿操作如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 准备基础文件</span>
$ <span class="token builtin class-name">cd</span> /data/test/docker/nginx/
$ <span class="token function">mkdir</span> test1 test2 test3
$ <span class="token builtin class-name">echo</span> test1 <span class="token operator">&gt;</span> test1/index.html
$ <span class="token builtin class-name">echo</span> test2 <span class="token operator">&gt;</span> test2/index.html
$ <span class="token builtin class-name">echo</span> test3 <span class="token operator">&gt;</span> test3/index.html
<span class="token comment"># 启动服务</span>
$ docker run --name test1 -v /data/test/docker/nginx/test1:/usr/share/nginx/html:ro -d -p <span class="token number">9901</span>:80  daocloud.io/library/nginx:1.15.9-alpine-perl
$ docker run --name test2 -v /data/test/docker/nginx/test2:/usr/share/nginx/html:ro -d -p <span class="token number">9902</span>:80  daocloud.io/library/nginx:1.15.9-alpine-perl
$ docker run --name test3 -v /data/test/docker/nginx/test3:/usr/share/nginx/html:ro -d -p <span class="token number">9903</span>:80  daocloud.io/library/nginx:1.15.9-alpine-perl
<span class="token comment"># 访问验证</span>
$ <span class="token function">curl</span> localhost:9901
test1
$ <span class="token function">curl</span> localhost:9902
test2
$ <span class="token function">curl</span> localhost:9903
test3
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>现在有了三个后端，访问之后能够返回对应的标识。</p><h3 id="_2-主要配置" tabindex="-1"><a class="header-anchor" href="#_2-主要配置" aria-hidden="true">#</a> 2，主要配置</h3><p>接下来进入Nginx的主要配置阶段，将如下内容放到Nginx的http区域：</p><div class="language-nginx ext-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> eryajf-test-upsync</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">upsync</span> 127.0.0.1:8500/v1/kv/prod/nginx/upstreams/eryajf-test-upsync/ upsync_timeout=2m upsync_interval=2s upsync_type=consul strong_dependency=off</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">upsync_dump_path</span> /etc/nginx/upsync/eryajf-test-upsync.config</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/upsync/eryajf-test-upsync.config</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">66</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://eryajf-test-upsync</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 便于观测后端代理列表</span>
    <span class="token directive"><span class="token keyword">location</span> /upstream_list</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">upstream_show</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li><code>upsync</code>：定义从consul拉取最新的upstream信息并存到本地的操作。 <ul><li><code>127.0.0.1:8500</code>：建议是在每台Nginx部署一个consul-client，统一请求127，降低server端压力。</li><li><code>upsync_timeout</code>：定义从consul拉取配置的超时时间。</li><li><code>upsync_interval</code>：定义从consul拉取配置的间隔时间</li><li><code>upsync_type</code>：配置同步接入类型，consul或者etcd。</li><li><code>strong_dependency</code>：启动时是否强制依赖配置服务器，如果配置为on,则拉取失败，nginx同样会启用失败。</li></ul></li><li><code>upsync_dump_path</code>：定义本地持久化目录，如果consul服务不可用，Nginx将会引用此路径。一般这个路径应与consul中的path一致。此文件需要预先创建，并且内容与后端配置一致。否则将检测失败。</li><li><code>include</code>：如果consul服务不可用，将会从上边dump的路径读取对应的配置。</li></ul><h2 id="_3-调试验证" tabindex="-1"><a class="header-anchor" href="#_3-调试验证" aria-hidden="true">#</a> 3，调试验证</h2><h3 id="_1-添加节点" tabindex="-1"><a class="header-anchor" href="#_1-添加节点" aria-hidden="true">#</a> 1，添加节点</h3><p>此时可通过如下请求添加一个后端：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -X PUT -d <span class="token string">&#39;{&quot;weight&quot;:1, &quot;max_fails&quot;:2, &quot;fail_timeout&quot;:10}&#39;</span> http://127.0.0.1:8500/v1/kv/prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9901
<span class="token boolean">true</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>返回true说明添加成功。</p><p>此时可在如下三个地方看到此配置：</p><ul><li><p><code>upsync_dump_path</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> /etc/nginx/upsync/eryajf-test-upsync.config
server <span class="token number">10.6</span>.6.66:9901 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p><code>server_upstream_list</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://10.6.6.66:66/upstream_list
Upstream name: eryajf-test-upsync<span class="token punctuation">;</span> Backend server count: <span class="token number">1</span>
        server <span class="token number">10.6</span>.6.66:9901 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p><code>consul_server</code></p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>$ curl -s http<span class="token operator">:</span><span class="token comment">//10.6.6.66:8500/v1/kv/?recurse | jq</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;LockIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9901&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Flags&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJ3ZWlnaHQiOjEwLCJtYXhfZmFpbHMiOjMsImZhaWxfdGltZW91dCI6MTAsImRvd24iOjB9&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;CreateIndex&quot;</span><span class="token operator">:</span> <span class="token number">14013</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ModifyIndex&quot;</span><span class="token operator">:</span> <span class="token number">14022</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>其中的Value是经过base64过的，使用如下命令可查看原内容：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>$ echo &#39;eyJ3ZWlnaHQiOjEwLCJtYXhfZmFpbHMiOjMsImZhaWxfdGltZW91dCI6MTAsImRvd24iOjB9&#39; | base64 -d | jq
<span class="token punctuation">{</span>
  <span class="token property">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token property">&quot;max_fails&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fail_timeout&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token property">&quot;down&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以及从web界面也可以直接看到：</p><p><img src="http://t.eryajf.net/imgs/2021/11/f6e55fb80d9c7154.jpg" alt=""></p></li></ul><h3 id="_2-再加节点" tabindex="-1"><a class="header-anchor" href="#_2-再加节点" aria-hidden="true">#</a> 2，再加节点</h3><p>这个时候再将另外两个节点加上：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -X PUT -d <span class="token string">&#39;{&quot;weight&quot;:1, &quot;max_fails&quot;:2, &quot;fail_timeout&quot;:10}&#39;</span> http://127.0.0.1:8500/v1/kv//prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9902
$ <span class="token function">curl</span> -X PUT -d <span class="token string">&#39;{&quot;weight&quot;:1, &quot;max_fails&quot;:2, &quot;fail_timeout&quot;:10}&#39;</span> http://127.0.0.1:8500/v1/kv//prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9903
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>再次查看如上三个信息：</p><ul><li><p><code>upsync_dump_path</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> /etc/nginx/upsync/eryajf-test-upsync.config
server <span class="token number">10.6</span>.6.66:9903 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
server <span class="token number">10.6</span>.6.66:9902 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
server <span class="token number">10.6</span>.6.66:9901 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p><code>server_upstream_list</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://10.6.6.66:66/upstream_list
Upstream name: eryajf-test-upsync<span class="token punctuation">;</span> Backend server count: <span class="token number">3</span>
        server <span class="token number">10.6</span>.6.66:9903 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
        server <span class="token number">10.6</span>.6.66:9902 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
        server <span class="token number">10.6</span>.6.66:9901 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p><code>consul_server</code></p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>$ curl -s http<span class="token operator">:</span><span class="token comment">//10.6.6.66:8500/v1/kv/?recurse | jq</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;LockIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9901&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Flags&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJ3ZWlnaHQiOjEsICJtYXhfZmFpbHMiOjIsICJmYWlsX3RpbWVvdXQiOjEwfQ==&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;CreateIndex&quot;</span><span class="token operator">:</span> <span class="token number">25518</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ModifyIndex&quot;</span><span class="token operator">:</span> <span class="token number">25518</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;LockIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9902&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Flags&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJ3ZWlnaHQiOjEsICJtYXhfZmFpbHMiOjIsICJmYWlsX3RpbWVvdXQiOjEwfQ==&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;CreateIndex&quot;</span><span class="token operator">:</span> <span class="token number">25525</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ModifyIndex&quot;</span><span class="token operator">:</span> <span class="token number">25525</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;LockIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9903&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Flags&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJ3ZWlnaHQiOjEsICJtYXhfZmFpbHMiOjIsICJmYWlsX3RpbWVvdXQiOjEwfQ==&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;CreateIndex&quot;</span><span class="token operator">:</span> <span class="token number">25527</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ModifyIndex&quot;</span><span class="token operator">:</span> <span class="token number">25527</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></li></ul><p>此时访问三次入口：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> a b c<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$i</span> <span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> localhost:66 <span class="token punctuation">;</span><span class="token keyword">done</span>
a
test3
b
test2
c
test1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_3-下线节点" tabindex="-1"><a class="header-anchor" href="#_3-下线节点" aria-hidden="true">#</a> 3，下线节点</h3><p>下线某个后端，因为Nginx不能将权重weight置为0，所以<a href="https://github.com/eryajf" target="_blank" rel="noopener noreferrer">二丫<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>操作down字段来实现下线一个后端：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -X PUT -d <span class="token string">&#39;{&quot;weight&quot;:1, &quot;max_fails&quot;:2, &quot;fail_timeout&quot;:10, &quot;down&quot;:1}&#39;</span> http://127.0.0.1:8500/v1/kv/prod/nginx/upstreams/eryajf-test-upsync/10.6.6.66:9902
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后看到相应的变化：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> /etc/nginx/upsync/eryajf-test-upsync.config
server <span class="token number">10.6</span>.6.66:9903 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
server <span class="token number">10.6</span>.6.66:9902 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s down<span class="token punctuation">;</span>
server <span class="token number">10.6</span>.6.66:9901 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>此时访问三次入口：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> a b c<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$i</span> <span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> localhost:66 <span class="token punctuation">;</span><span class="token keyword">done</span>
a
test3
b
test1
c
test3
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到已经没有test2的返回了。</p><h2 id="_4-go客户端" tabindex="-1"><a class="header-anchor" href="#_4-go客户端" aria-hidden="true">#</a> 4，go客户端</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/json&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>

	consulapi <span class="token string">&quot;github.com/hashicorp/consul/api&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	consulAddress <span class="token operator">=</span> <span class="token string">&quot;10.6.6.14:8500&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">InitConsulCli</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>consulapi<span class="token punctuation">.</span>Client <span class="token punctuation">{</span>
	config <span class="token operator">:=</span> consulapi<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	config<span class="token punctuation">.</span>Address <span class="token operator">=</span> consulAddress
	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> consulapi<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;init consul client failed,err: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> client
<span class="token punctuation">}</span>

<span class="token keyword">type</span> NgConsulKey <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Env     <span class="token builtin">string</span> <span class="token string">`json:&quot;env&quot;`</span>
	Service <span class="token builtin">string</span> <span class="token string">`json:&quot;service&quot;`</span>
	Backend <span class="token builtin">string</span> <span class="token string">`json:&quot;backend&quot;`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> NgConsulValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Weight      <span class="token builtin">int</span> <span class="token string">`json:&quot;weight&quot;`</span>
	MaxFails    <span class="token builtin">int</span> <span class="token string">`json:&quot;max_fails&quot;`</span>
	FailTimeout <span class="token builtin">int</span> <span class="token string">`json:&quot;fail_timeout&quot;`</span>
	Down        <span class="token builtin">int</span> <span class="token string">`json:&quot;down&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Addkv</span><span class="token punctuation">(</span>k NgConsulKey<span class="token punctuation">,</span> v NgConsulValue<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>consulapi<span class="token punctuation">.</span>WriteMeta<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	kv <span class="token operator">:=</span> <span class="token function">InitConsulCli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">KV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	p <span class="token operator">:=</span> <span class="token operator">&amp;</span>consulapi<span class="token punctuation">.</span>KVPair<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s/nginx/upstreams/%s/%s&quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">.</span>Env<span class="token punctuation">,</span> k<span class="token punctuation">.</span>Service<span class="token punctuation">,</span> k<span class="token punctuation">.</span>Backend<span class="token punctuation">)</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">}</span>
	wm<span class="token punctuation">,</span> err <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> wm<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	key <span class="token operator">:=</span> NgConsulKey<span class="token punctuation">{</span>
		Env<span class="token punctuation">:</span>     <span class="token string">&quot;prod&quot;</span><span class="token punctuation">,</span>
		Service<span class="token punctuation">:</span> <span class="token string">&quot;eryajf-api-upsync&quot;</span><span class="token punctuation">,</span>
		Backend<span class="token punctuation">:</span> <span class="token string">&quot;10.6.6.66:9902&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	value <span class="token operator">:=</span> NgConsulValue<span class="token punctuation">{</span>
		Weight<span class="token punctuation">:</span>      <span class="token number">10</span><span class="token punctuation">,</span>
		MaxFails<span class="token punctuation">:</span>    <span class="token number">3</span><span class="token punctuation">,</span>
		FailTimeout<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
		Down<span class="token punctuation">:</span>        <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Addkv</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;add kv failed:%v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;add kv success&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>可以通过调整参数，添加不同的对象，通过调整weight调整后端的权重，通过调整down字段来决定后端服务上下线。</p><h2 id="_5-参考" tabindex="-1"><a class="header-anchor" href="#_5-参考" aria-hidden="true">#</a> 5，参考</h2><ul><li><a href="https://sq.sf.163.com/blog/article/375808724630351872" target="_blank" rel="noopener noreferrer">效率倍增！网易杭研Nginx自动扩缩容实践<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ul><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/eryajf/eryajf.github.io/edit/main/01.运维观止/66.Consul/02.Nginx+consul实现集群主机优雅扩缩容.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: fengxuechao@tal.com">fengxuechao</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="./assets/app.dbf5d933.js" defer></script>
  </body>
</html>
